<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / Mobile Web App è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <title>ç¾½çƒæ’ç¨‹</title>
    
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/zxuan-c/badminton-partner-v4/refs/heads/main/icon.jpg">

    <!-- Supabase SDK (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root {
            --primary: #2c3e50;
            --accent: #27ae60; /* ç¶ è‰² */
            --danger: #e74c3c; /* ç´…è‰² */
            --warning: #f1c40f; /* é»ƒè‰² */
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #333;
            --modal-bg: rgba(0, 0, 0, 0.7);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            height: 100vh; height: 100dvh;
            display: flex; flex-direction: column;
            color: var(--text);
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        button {
            cursor: pointer; border: none; outline: none;
            font-family: inherit; font-weight: bold;
            transition: transform 0.1s, opacity 0.1s, filter 0.1s;
        }
        button:active { transform: scale(0.96); opacity: 0.9; }

        /* --- å…¨è¢å¹•è¨ˆåˆ†æ¨¡å¼ --- */
        #fs-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100svh;
            background: #000; z-index: 2000;
            flex-direction: column; color: white;
            padding-top: max(env(safe-area-inset-top), 10px);
            padding-bottom: max(env(safe-area-inset-bottom), 10px);
        }
        #fs-overlay.show { display: flex; }

        .fs-close-btn {
            position: absolute; top: max(env(safe-area-inset-top), 20px); right: 20px;
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(255,255,255,0.15); color: white;
            font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
            z-index: 2001; backdrop-filter: blur(5px);
        }

        /* ç‚ºäº†æ–¹ä¾¿å°é¢çš„äººçœ‹ï¼Œé è¨­ flex-direction: row-reverse */
        .fs-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            padding: 0 10px; width: 100%; height: 100%; overflow: hidden;
            flex-direction: row-reverse; 
        }

        .fs-team {
            flex: 1; height: 100%; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }

        /* ç”¨æ–¼é¡¯ç¤ºç•¶å‰ç™¼çƒæ–¹/å¾—åˆ†æ–¹çš„èƒŒæ™¯å…‰æšˆ */
        .fs-team.serving::before {
            content: ''; position: absolute;
            width: 80%; height: 60%;
            background: radial-gradient(circle, rgba(39, 174, 96, 0.2) 0%, rgba(0,0,0,0) 70%);
            z-index: -1; opacity: 1; transition: opacity 0.3s;
        }

        .fs-names {
            font-size: clamp(1.5rem, 6vmin, 3rem); color: #bbb;
            text-align: center; margin-bottom: 1vh; font-weight: 700;
            line-height: 1.2; padding: 0 10px; word-break: break-word;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .fs-score {
            font-size: 40vmin; font-weight: 800; color: white;
            line-height: 0.9; margin-bottom: 2vh;
            font-variant-numeric: tabular-nums; cursor: pointer;
            text-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .fs-score.winner { color: var(--accent); text-shadow: 0 0 30px rgba(39, 174, 96, 0.6); }

        .fs-controls { display: flex; gap: 30px; }

        .fs-btn {
            width: 12vmin; height: 12vmin;
            min-width: 60px; min-height: 60px;
            border-radius: 50%; font-size: 2rem;
            display: flex; align-items: center; justify-content: center;
            color: white; backdrop-filter: blur(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .fs-btn.minus { background: rgba(231, 76, 60, 0.2); border: 2px solid var(--danger); }
        .fs-btn.plus { background: rgba(39, 174, 96, 0.2); border: 2px solid var(--accent); }

        .fs-divider {
            width: 2px; height: 60%; background: #333;
            margin: 0 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .fs-divider::after {
            content: 'â‡„'; color: #555; font-size: 2rem; background: #000; padding: 10px;
        }

        /* --- å½ˆè·³è¦–çª— (Modal) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 9999;
            justify-content: center; align-items: center; backdrop-filter: blur(3px);
        }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
        
        .modal-card {
            background: white; width: 85%; max-width: 320px; padding: 25px;
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-title { font-size: 1.4rem; font-weight: 900; color: var(--primary); margin-bottom: 10px; }
        .modal-msg { font-size: 1rem; color: #555; margin-bottom: 25px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 12px; font-size: 1rem; }
        .btn-cancel { background: #f1f3f5; color: #666; }
        .btn-confirm { background: var(--accent); color: white; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- é é¢å®¹å™¨ --- */
        .page {
            flex: 1; display: flex; flex-direction: column;
            padding: 15px; width: 100%; max-width: 600px;
            margin: 0 auto; height: 100%;
        }

        #setup-page { display: none; overflow-y: auto; }
        
        .setup-card {
            background: var(--card); padding: 30px 25px; border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%;
        }

        input {
            width: 100%; padding: 15px; font-size: 1.1rem;
            border: 2px solid #eee; border-radius: 12px; margin-bottom: 15px;
            background: #f9f9f9; -webkit-appearance: none; outline: none;
        }
        input:focus { border-color: var(--accent); background: white; }
        
        .player-tag {
            display: inline-flex; align-items: center; background: #fff;
            padding: 8px 16px; border-radius: 30px; margin: 5px;
            font-size: 1rem; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .player-tag span { 
            color: #bbb; margin-left: 10px; cursor: pointer; 
            font-size: 1.2rem; width: 20px; height: 20px; text-align: center; line-height: 20px;
        }
        .player-tag span:hover { color: var(--danger); }

        /* ç§»é™¤ Mode Selector */
        /* .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; } */

        /* --- ä¸»æ‡‰ç”¨é é¢ (è¨ˆåˆ†æ¿) --- */
        #app-page {
            display: none; flex-direction: column; padding: 0;
            max-width: 100%; height: 100%; background: #1a1a1a;
        }

        .scoreboard-section {
            flex: 1; background: white;
            border-radius: 0 0 40px 40px;
            display: flex; flex-direction: column;
            padding: 15px 20px 25px 20px;
            position: relative; z-index: 10;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow-y: auto;
        }

        .match-info-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; color: #888; font-size: 0.95rem;
        }
        .match-badge { background: #f0f2f5; padding: 4px 10px; border-radius: 6px; font-weight: 600; color: #555; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-right: 5px; display:inline-block;}
        .status-dot.online { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

        .scores-display {
            display: flex; align-items: center; justify-content: space-between;
            flex: 1; margin-bottom: 10px;
        }

        .team-block {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 100%;
        }

        .team-names {
            font-size: 1.4rem; font-weight: 800; text-align: center;
            color: #2c3e50; margin-bottom: 10px; min-height: 3.2rem;
            display: flex; flex-direction: column; justify-content: flex-end;
            line-height: 1.1;
        }

        .score-number {
            font-size: clamp(5rem, 18vh, 9rem); line-height: 0.9;
            font-weight: 800; color: var(--primary); margin: 5px 0 20px 0;
            font-variant-numeric: tabular-nums; cursor: pointer;
            transition: color 0.2s;
        }
        .score-number.winner { color: var(--accent); }

        .score-controls { display: flex; gap: 15px; }

        .btn-control {
            width: 60px; height: 60px; border-radius: 20px;
            font-size: 1.8rem; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); color: white;
            position: relative; overflow: hidden;
        }
        .btn-control::after {
            content:''; position: absolute; width:100%; height:100%; 
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
        }
        .btn-minus { background-color: var(--danger); }
        .btn-plus { background-color: var(--accent); }

        .vs-column {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 10px; opacity: 0.7; /* å¢åŠ ä¸é€æ˜åº¦ */
        }
        .vs-text { 
            font-size: 2.5rem; /* æ”¾å¤§ */
            font-weight: 900; 
            font-style: italic; 
            color: #ccc; 
            margin-bottom: 5px;
        }
        .btn-swap { 
            font-size: 2.2rem; /* æ”¾å¤§ */
            color: #999; 
            padding: 12px; 
            background: #f8f9fa; 
            border-radius: 50%; 
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn-swap:active { transform: scale(0.95); background: #eee; }

        .next-match-area {
            margin-top: auto; padding-top: 10px; display: flex; gap: 10px;
        }
        .btn-finish {
            flex: 2; background: var(--primary); color: white;
            padding: 18px; font-size: 1.1rem; font-weight: bold; border-radius: 16px;
            box-shadow: 0 8px 20px rgba(44, 62, 80, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-prev {
            flex: 1; background: #fff; color: #666; border: 2px solid #eee;
            padding: 15px; font-size: 1rem; font-weight: bold; border-radius: 16px;
        }

        /* --- è³½ç¨‹è¡¨å€å¡Š --- */
        .schedule-section {
            height: 35vh; min-height: 200px; flex: none;
            background: #1a1a1a; padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .schedule-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; color: #666;
        }
        .schedule-title { color: #888; font-weight: bold; font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase;}

        .match-card {
            background: #2a2a2a; border-radius: 12px; padding: 14px;
            margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
            color: #eee; border-left: 4px solid #444; transition: all 0.3s;
        }
        .match-card.active { border-left-color: var(--accent); background: #333; transform: translateX(5px); }
        .match-card.finished { opacity: 0.5; }
        
        .score-badge {
            background: #444; padding: 4px 12px; border-radius: 6px;
            font-weight: bold; color: #aaa; min-width: 65px; text-align: center;
            font-family: monospace; font-size: 1rem;
        }
        .active .score-badge { background: var(--accent); color: white; }

        /* --- å…±ç”¨æŒ‰éˆ•èˆ‡å·¥å…· --- */
        .btn-green { background: var(--accent); color: white; border-radius: 12px; padding: 12px 20px; font-weight: bold; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3); }
        .btn-icon { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 8px; color: #fff; }
        .toolbar { display: flex; gap: 10px; }
        .toolbar button { background: #333; color: #ccc; border: 1px solid #444; border-radius: 8px; padding: 6px 12px; font-size: 0.8rem; }
        
        /* çµ±ä¸€çš„æ“ä½œæŒ‰éˆ•æ¨£å¼ */
        .btn-action {
            border-radius: 12px;
            padding: 8px 14px;
            font-size: 0.9rem;
            font-weight: bold;
            display: flex; align-items: center; gap: 6px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            transition: all 0.1s;
            cursor: pointer;
            border: none;
            white-space: nowrap;
        }
        .btn-action:active { transform: scale(0.96); opacity: 0.9; }

        /* é‡æ–°æ•´ç†æŒ‰éˆ• (æ¬¡è¦é¢¨æ ¼ï¼šç™½åº•ç°å­—) */
        .btn-refresh {
            background: #ffffff; 
            color: #555;
            border: 1px solid #ddd;
        }

        /* å…¨è¢å¹•æŒ‰éˆ• (ä¸»è¦é¢¨æ ¼ï¼šæ·±è—åº•ç™½å­—) */
        .btn-fullscreen {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }

        .spinning { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* è¼‰å…¥é®ç½© */
        #global-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
    </style>
</head>
<body>

    <!-- Global Loader -->
    <div id="global-loader">
        <div style="font-size: 4rem; margin-bottom: 20px;" class="spinning">ğŸ¸</div>
        <div style="color:#666; font-weight:bold;">æ­£åœ¨é€£ç·šåˆ°ç¾½çƒæ’ç¨‹...</div>
    </div>

    <!-- å…¨è¢å¹•è¨ˆåˆ†æ¨¡å¼ -->
    <div id="fs-overlay">
        <button class="fs-close-btn" onclick="closeFullscreen()">âœ•</button>
        <div class="fs-container">
            <!-- é€™è£¡ç”¨ row-reverse æ˜¯ç‚ºäº†è®“ç«™åœ¨å°é¢çš„äººçœ‹åˆ°æ­£ç¢ºçš„æ–¹ä½ -->
            <div class="fs-team" id="fs-t1-box">
                <div class="fs-names" id="fs-t1-names">Team 1</div>
                <div class="fs-score" id="fs-t1-score" onclick="updateScore(1, 1)">0</div>
                <div class="fs-controls">
                    <button class="fs-btn minus" onclick="updateScore(1, -1)">-</button>
                    <button class="fs-btn plus" onclick="updateScore(1, 1)">+</button>
                </div>
            </div>
            
            <div class="fs-divider" onclick="swapTeams()" title="äº¤æ›å ´åœ°"></div>

            <div class="fs-team" id="fs-t2-box">
                <div class="fs-names" id="fs-t2-names">Team 2</div>
                <div class="fs-score" id="fs-t2-score" onclick="updateScore(2, 1)">0</div>
                <div class="fs-controls">
                    <button class="fs-btn minus" onclick="updateScore(2, -1)">-</button>
                    <button class="fs-btn plus" onclick="updateScore(2, 1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å½ˆè·³è¦–çª— -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-msg" id="modal-msg"></div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" id="modal-confirm-btn">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- 1. è¨­å®šé é¢ (é¦–é ) -->
    <div id="setup-page" class="page">
        <div class="setup-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h2 style="color: var(--primary); margin:0;">ç¾½çƒæ’ç¨‹ (Global)</h2>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="status-dot" id="connection-dot-setup" style="margin-right:0;"></span>
                    <!-- çµ±ä¸€è¨­è¨ˆçš„é‡æ–°æ•´ç†æŒ‰éˆ• -->
                    <button class="btn-action btn-refresh" onclick="refreshData()">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
            </div>
            
            <!-- ç›®æ¨™åˆ†æ•¸ (å›ºå®šé¡¯ç¤º) -->
            <div style="background:#f9f9f9; padding:15px; border-radius:12px; text-align:center; margin-bottom:20px; color:#666;">
                è³½åˆ¶ï¼š<strong style="color:var(--primary);">11åˆ†åˆ¶</strong>
            </div>

            <label style="display:block; color:#888; font-size:0.9rem; margin-bottom:8px;">çƒå“¡åå–® (ç”±ä¸Šå ´æ¬¡æ•¸è‡ªå‹•æ’åº)</label>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="input-name" placeholder="è¼¸å…¥åå­—..." autocomplete="off" style="margin-bottom:0;">
                <button class="btn-green" onclick="addPlayer()" style="width:80px;">+</button>
            </div>

            <div id="player-list" style="margin-bottom:30px; min-height: 60px; display:flex; flex-wrap:wrap;"></div>

            <button class="btn-green" style="width:100%; padding:16px; font-size:1.1rem; margin-bottom:15px;" onclick="startSystem()">
                é–‹å§‹ / ç¹¼çºŒæ¯”è³½
            </button>
        </div>
    </div>

    <!-- 2. ä¸»æ‡‰ç”¨é é¢ (è¨ˆåˆ†æ¿) -->
    <div id="app-page">
        <div class="scoreboard-section">
            <div class="match-info-bar">
                <div style="display:flex; align-items:center;">
                    <span class="status-dot" id="connection-dot-app"></span>
                    <span class="match-badge">Match <span id="match-id">1</span></span>
                    <span class="match-badge" style="margin-left:5px; background:#fff; border:1px solid #eee;" id="target-score-display">11</span>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <!-- çµ±ä¸€è¨­è¨ˆçš„æŒ‰éˆ• -->
                    <button class="btn-action btn-refresh" onclick="refreshData()">ğŸ”„ é‡æ–°æ•´ç†</button>
                    <button class="btn-action btn-fullscreen" onclick="openFullscreen()">â›¶ å…¨è¢å¹•</button>
                </div>
            </div>

            <div class="scores-display">
                <div class="team-block">
                    <div class="team-names" id="t1-names"></div>
                    <div class="score-number" id="t1-score" onclick="updateScore(1, 1)">0</div>
                    <div class="score-controls">
                        <button class="btn-control btn-minus" onclick="updateScore(1, -1)">-</button>
                        <button class="btn-control btn-plus" onclick="updateScore(1, 1)">+</button>
                    </div>
                </div>
                
                <div class="vs-column">
                    <div class="vs-text">VS</div>
                    <button class="btn-swap" onclick="swapTeams()" title="äº¤æ›å ´åœ°">â‡„</button>
                </div>

                <div class="team-block">
                    <div class="team-names" id="t2-names"></div>
                    <div class="score-number" id="t2-score" onclick="updateScore(2, 1)">0</div>
                    <div class="score-controls">
                        <button class="btn-control btn-minus" onclick="updateScore(2, -1)">-</button>
                        <button class="btn-control btn-plus" onclick="updateScore(2, 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="next-match-area">
                <button class="btn-prev" onclick="goToPreviousMatch()">â¬…ï¸ ä¸Šä¸€å ´</button>
                <button class="btn-finish" id="main-action-btn" onclick="manualFinishClick()">
                    <span>ä¸‹ä¸€å ´</span> â”
                </button>
            </div>
        </div>

        <div class="schedule-section">
            <div class="schedule-header">
                <span class="schedule-title">SCHEDULE</span>
                <div class="toolbar">
                    <button onclick="clearData()" style="color:var(--danger); border-color:var(--danger);">é‡ç½®</button>
                    <button onclick="addMoreMatches()">+ 20å ´</button>
                </div>
            </div>
            <div id="schedule-container" style="padding-bottom:20px;"></div>
        </div>
    </div>

    <script>
        // --- è¨­å®š ---
        const GLOBAL_ROOM_ID = 'badminton_global_room_v1';
        const SUPABASE_URL = 'https://dgdolkbubvyggijsddtl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_-tIVFIoo0VXjtrWrKadCgw__QO8IAbW';

        // --- è®Šæ•¸ ---
        let supabase;
        let realtimeChannel = null;
        let wakeLock = null;

        // --- App State ---
        const DEFAULT_STATE = {
            players: [],
            schedule: [],
            currentIdx: 0,
            targetScore: 11, // å›ºå®š 11 åˆ†
            timestamp: 0 
        };
        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        let isModalOpen = false;

        // --- Wake Lock (é˜²æ­¢è¢å¹•ä¼‘çœ ) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => { console.log('Wake Lock released'); });
                } catch (err) { /* ignore */ }
            }
        }
        
        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.supabase === 'undefined') {
                alert("Supabase SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                return;
            }
            // @ts-ignore
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            document.getElementById('input-name').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addPlayer();
            });

            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    await requestWakeLock();
                }
            });

            initGlobalRoom();
        });

        // --- æˆ¿é–“èˆ‡é€£ç·šé‚è¼¯ ---
        async function initGlobalRoom() {
            await refreshData(true); 
            if(realtimeChannel) await supabase.removeChannel(realtimeChannel);
            realtimeChannel = supabase
                .channel('room-updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms', filter: `id=eq.${GLOBAL_ROOM_ID}` },
                    (payload) => {
                        if(payload.new && payload.new.data) {
                            state = payload.new.data;
                            syncUI();
                        }
                    }
                )
                .subscribe((status) => {
                    const dot1 = document.getElementById('connection-dot-setup');
                    const dot2 = document.getElementById('connection-dot-app');
                    const isOnline = (status === 'SUBSCRIBED');
                    if(dot1) dot1.classList.toggle('online', isOnline);
                    if(dot2) dot2.classList.toggle('online', isOnline);
                });
            
            document.getElementById('global-loader').style.display = 'none';
            requestWakeLock();
        }

        async function refreshData(isInitial = false) {
            if(!supabase) return;
            
            const { data, error } = await supabase
                .from('rooms')
                .select('data')
                .eq('id', GLOBAL_ROOM_ID)
                .single();

            if (error && error.code !== 'PGRST116') { 
                if(!isInitial) console.error("Sync Error", error);
                return;
            }

            if (data && data.data) {
                state = data.data;
                state.targetScore = 11;
                syncUI();
            } else if (isInitial) {
                await saveData(); 
                syncUI();
            }
        }

        async function saveData() {
            if(!supabase) return;
            state.timestamp = Date.now();
            const { error } = await supabase
                .from('rooms')
                .upsert({ id: GLOBAL_ROOM_ID, data: state });
            if(error) console.error("Save error:", error);
        }

        // --- UI åŒæ­¥èˆ‡æ¸²æŸ“ ---
        function syncUI() {
            renderPlayers();
            if(state.schedule.length > 0) {
                if (typeof state.currentIdx !== 'number' || state.currentIdx < 0) state.currentIdx = 0;
                if (state.currentIdx >= state.schedule.length) state.currentIdx = state.schedule.length - 1;

                const m = state.schedule[state.currentIdx];
                if(m && m.status === 'pending') {
                    m.status = 'active';
                }

                updateScoreUI();
                renderSchedule();
                
                const setupPage = document.getElementById('setup-page');
                const appPage = document.getElementById('app-page');
                if (setupPage.style.display !== 'none' || (setupPage.style.display === 'none' && appPage.style.display === 'none')) {
                     showAppPage();
                }
            } else {
                showSetupPage();
            }
        }

        function showSetupPage() {
            document.getElementById('app-page').style.display = 'none';
            document.getElementById('setup-page').style.display = 'flex';
        }

        function showAppPage() {
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'flex';
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function swapTeams() {
            if(state.schedule.length === 0) return;
            const m = state.schedule[state.currentIdx];
            if(m.status === 'finished') {
                if(!confirm("é€™å ´æ¯”è³½å·²çµæŸï¼Œç¢ºå®šè¦äº¤æ›éšŠä¼ä¸¦ä¿®æ”¹å—ï¼Ÿ")) return;
                m.status = 'active'; 
            }
            [m.t1, m.t2] = [m.t2, m.t1];
            [m.s1, m.s2] = [m.s2, m.s1];
            saveData();
            syncUI();
        }

        function addPlayer() {
            const input = document.getElementById('input-name');
            const name = input.value.trim();
            if(!name) return;
            if(state.players.find(p => p.name === name)) { 
                showModal("æç¤º", "åå­—é‡è¤‡å›‰", ()=>{}); return; 
            }
            state.players.push({ name, played: 0 });
            input.value = '';
            saveData();
        }

        function renderPlayers() {
            const div = document.getElementById('player-list');
            if(state.players.length === 0) {
                div.innerHTML = '<p style="color:#bbb; width:100%; text-align:center;">æš«ç„¡åå–®</p>';
                return;
            }
            div.innerHTML = state.players.map((p, i) => `
                <div class="player-tag">${p.name} <span onclick="removePlayer(${i})">Ã—</span></div>
            `).join('');
        }

        function removePlayer(idx) {
            state.players.splice(idx, 1);
            saveData();
        }

        function startSystem() {
            if(state.players.length < 4) { showModal("æç¤º","è‡³å°‘éœ€è¦ 4 ä½çƒå“¡æ‰èƒ½ç”¢ç”Ÿé›™æ‰“è³½ç¨‹",()=>{}); return; }
            state.targetScore = 11; 
            if(state.schedule.length === 0) {
                generateMatches(20); 
            }
            saveData();
        }

        // --- é€²éšåˆ†çµ„æ¼”ç®—æ³• ---
        // æ ¸å¿ƒç›®æ¨™ï¼š1. æ¯å€‹äººå ´æ•¸å¹³å‡ 2. é¿å…é€£çºŒä¸Šå ´è¶…éä¸€æ¬¡ 3. çµ„åˆå¤šæ¨£åŒ–(é¿å…å›ºå®šåˆ†çµ„)
        function generateMatches(count) {
            let startId = state.schedule.length + 1;
            
            // å»ºç«‹æ­·å²æ­æª”ç´€éŒ„ (ç‚ºäº†å¤šæ¨£æ€§)
            let partnerCounts = {}; 
            // å»ºç«‹é€£çºŒä¸Šå ´ç´€éŒ„ (ç‚ºäº†ä¸é€£çºŒ)
            let consecutiveCounts = {};
            
            state.players.forEach(p => {
                partnerCounts[p.name] = {};
                state.players.forEach(p2 => partnerCounts[p.name][p2.name] = 0);
                consecutiveCounts[p.name] = 0;
            });

            // å›å¡«æ­·å²æ•¸æ“š (å¾å·²ç”Ÿæˆçš„è³½ç¨‹)
            state.schedule.forEach(m => {
                // æ›´æ–°æ­æª”æ¬¡æ•¸
                updatePairCount(partnerCounts, m.t1);
                updatePairCount(partnerCounts, m.t2);
                
                // æ›´æ–°é€£çºŒä¸Šå ´æ¬¡æ•¸
                state.players.forEach(p => {
                    const playedInMatch = m.t1.includes(p.name) || m.t2.includes(p.name);
                    if (playedInMatch) consecutiveCounts[p.name]++;
                    else consecutiveCounts[p.name] = 0; // åªè¦æœ‰ä¸€å ´ä¼‘æ¯ï¼Œé€£çºŒæ¬¡æ•¸æ­¸é›¶
                });
            });

            for(let i=0; i<count; i++) {
                let pool = [...state.players];
                
                // --- æ­¥é©Ÿ 1: é¸äºº (Selection) ---
                // è¨ˆç®—æ¯å€‹äººçš„å„ªå…ˆæ¬Šé‡ (åˆ†æ•¸è¶Šå°è¶Šå„ªå…ˆ)
                pool.forEach(p => {
                    // 1. ä¸Šå ´æ¬¡æ•¸æ¬Šé‡ (æœ€é«˜å„ªå…ˆç´š)
                    let score = p.played * 100000; 
                    
                    // 2. é€£çºŒä¸Šå ´æ¬Šé‡
                    // - å‰›æ‰“é1å ´ (consecutive=1): åŠ  1500 åˆ† (å°è™•ç½°)
                    // - å‰›æ‰“é2å ´ (consecutive>=2): åŠ  50000 åˆ† (å¤§è™•ç½°ï¼Œå¼·åˆ¶ä¼‘æ¯)
                    if (consecutiveCounts[p.name] >= 1) score += 1500;
                    if (consecutiveCounts[p.name] >= 2) score += 50000; 

                    // 3. éš¨æ©Ÿæ“¾å‹•æ¬Šé‡
                    // - ç¯„åœ 0~8000 (å¢åŠ åˆ°æ¯” 1500 å¤§å¾ˆå¤šï¼Œè®“å‰›ä¸‹å ´çš„äººæœ‰è¼ƒé«˜æ©Ÿç‡ç¹¼çºŒæ‰“)
                    // - é€™æœƒæ‰“ç ´ 8 äººå±€çš„å›ºå®šåˆ†çµ„
                    score += Math.random() * 8000;
                    
                    p.sortScore = score;
                });

                // æ’åºä¸¦å–å‰ 4 å
                pool.sort((a, b) => a.sortScore - b.sortScore);
                let picked = pool.slice(0, 4);

                // --- æ­¥é©Ÿ 2: åˆ†çµ„ (Pairing) ---
                // 4äººæœ‰ 3 ç¨®æ­æª”æ–¹å¼ï¼Œé¸æ“‡ã€Œæ­·å²æ­æª”æ¬¡æ•¸ç¸½å’Œã€æœ€å°çš„é‚£ç¨®
                const combinations = [
                    [[picked[0], picked[1]], [picked[2], picked[3]]],
                    [[picked[0], picked[2]], [picked[1], picked[3]]],
                    [[picked[0], picked[3]], [picked[1], picked[2]]]
                ];
                
                // è¨ˆç®—æ¯ç¨®çµ„åˆçš„ã€Œé‡è¤‡æˆæœ¬ã€
                let bestCombo = combinations[0];
                let minCost = Infinity;

                combinations.forEach(combo => {
                    const pair1 = combo[0];
                    const pair2 = combo[1];
                    // Cost = å…©éšŠæ­æª”éçš„æ¬¡æ•¸åŠ ç¸½ + éš¨æ©Ÿå€¼ (å¢åŠ éš¨æ©Ÿæ€§ï¼Œé¿å…åƒµåŒ–)
                    let cost = partnerCounts[pair1[0].name][pair1[1].name] + 
                               partnerCounts[pair2[0].name][pair2[1].name] +
                               Math.random() * 1.5;
                    
                    if (cost < minCost) {
                        minCost = cost;
                        bestCombo = combo;
                    }
                });

                const t1Names = bestCombo[0].map(p => p.name);
                const t2Names = bestCombo[1].map(p => p.name);

                // --- æ­¥é©Ÿ 3: æ›´æ–°ç‹€æ…‹ (Simulate) ---
                // æ›´æ–°ç¸½å ´æ•¸
                picked.forEach(p => {
                    const realP = state.players.find(x => x.name === p.name);
                    if(realP) realP.played++;
                });
                
                // æ›´æ–°é€£çºŒä¸Šå ´è¨ˆæ•¸ (for next iteration)
                state.players.forEach(p => {
                    const isPlaying = picked.some(pick => pick.name === p.name);
                    if (isPlaying) consecutiveCounts[p.name]++;
                    else consecutiveCounts[p.name] = 0;
                });

                // æ›´æ–°æ­æª”ç´€éŒ„
                updatePairCount(partnerCounts, t1Names);
                updatePairCount(partnerCounts, t2Names);

                state.schedule.push({
                    id: startId + i,
                    t1: t1Names,
                    t2: t2Names,
                    s1: 0, s2: 0,
                    status: 'pending' 
                });
            }
        }

        function updatePairCount(matrix, teamArr) {
            if(teamArr.length < 2) return;
            const p1 = teamArr[0];
            const p2 = teamArr[1];
            if(!matrix[p1]) matrix[p1] = {};
            if(!matrix[p2]) matrix[p2] = {};
            if(!matrix[p1][p2]) matrix[p1][p2] = 0;
            if(!matrix[p2][p1]) matrix[p2][p1] = 0;
            matrix[p1][p2]++;
            matrix[p2][p1]++;
        }

        function updateScoreUI() {
            if(!state.schedule[state.currentIdx]) return;
            const m = state.schedule[state.currentIdx];
            const target = 11; 

            document.getElementById('match-id').innerText = m.id;
            document.getElementById('target-score-display').innerText = target;
            
            const s1Elem = document.getElementById('t1-score');
            const s2Elem = document.getElementById('t2-score');
            const fsS1Elem = document.getElementById('fs-t1-score');
            const fsS2Elem = document.getElementById('fs-t2-score');

            s1Elem.className = 'score-number' + (m.s1 > m.s2 && m.status==='finished' ? ' winner' : '');
            s2Elem.className = 'score-number' + (m.s2 > m.s1 && m.status==='finished' ? ' winner' : '');
            
            document.getElementById('t1-names').innerHTML = `<span>${m.t1[0]}</span><span>${m.t1[1]}</span>`;
            document.getElementById('t2-names').innerHTML = `<span>${m.t2[0]}</span><span>${m.t2[1]}</span>`;
            s1Elem.innerText = m.s1;
            s2Elem.innerText = m.s2;

            document.getElementById('fs-t1-names').innerHTML = `${m.t1[0]}<br>${m.t1[1]}`;
            document.getElementById('fs-t2-names').innerHTML = `${m.t2[0]}<br>${m.t2[1]}`;
            fsS1Elem.innerText = m.s1;
            fsS2Elem.innerText = m.s2;
            
            fsS1Elem.className = 'fs-score' + (m.s1 > m.s2 && m.status==='finished' ? ' winner' : '');
            fsS2Elem.className = 'fs-score' + (m.s2 > m.s1 && m.status==='finished' ? ' winner' : '');

            const btn = document.getElementById('main-action-btn');
            if (m.status === 'finished') {
                btn.innerHTML = "<span>ä¿®æ”¹åˆ†æ•¸</span> (å·²çµæŸ)";
                btn.style.background = '#7f8c8d';
                btn.onclick = resumeMatch;
            } else {
                btn.innerHTML = "<span>ä¸‹ä¸€å ´</span> â”";
                btn.style.background = 'var(--primary)';
                btn.onclick = manualFinishClick;
            }
        }

        function updateScore(team, delta) {
            if(isModalOpen) return;
            const m = state.schedule[state.currentIdx];
            if(m.status === 'finished') {
                if(confirm("æ¯”è³½å·²çµæŸã€‚è¦æ¢å¾©æ¯”è³½ä¸¦ä¿®æ”¹åˆ†æ•¸å—ï¼Ÿ")) m.status = 'active';
                else return;
            }

            const oldS1 = m.s1;
            const oldS2 = m.s2;
            if(team === 1) m.s1 = Math.max(0, m.s1 + delta);
            else m.s2 = Math.max(0, m.s2 + delta);

            if(m.s1 === oldS1 && m.s2 === oldS2) return;

            const target = 11;
            const maxS = Math.max(m.s1, m.s2);
            const diff = Math.abs(m.s1 - m.s2);
            if (maxS >= target && diff >= 2) finishMatch(state.currentIdx);
            else { saveData(); syncUI(); }
        }

        function manualFinishClick() {
            const m = state.schedule[state.currentIdx];
            if(m.status === 'finished') {
                let nextIdx = state.schedule.findIndex((match, i) => i > state.currentIdx && match.status !== 'finished');
                if(nextIdx !== -1) {
                    state.currentIdx = nextIdx;
                    state.schedule[nextIdx].status = 'active';
                    saveData();
                } else {
                    addMoreMatches();
                }
            } else {
                if(confirm("ç¢ºå®šçµæŸæœ¬å ´æ¯”è³½ï¼Ÿ")) finishMatch(state.currentIdx);
            }
        }

        function finishMatch(idx) {
            if(state.schedule[idx]) {
                state.schedule[idx].status = 'finished';
                let nextIdx = idx + 1;
                if(nextIdx >= state.schedule.length) { } 
                else {
                    state.currentIdx = nextIdx;
                    if(state.schedule[nextIdx].status === 'pending') state.schedule[nextIdx].status = 'active';
                }
                saveData();
                syncUI();
            }
        }

        function resumeMatch() {
            const m = state.schedule[state.currentIdx];
            if (m) { m.status = 'active'; saveData(); syncUI(); }
        }

        function goToPreviousMatch() {
            if (state.currentIdx > 0) { state.currentIdx--; saveData(); syncUI(); }
        }

        function addMoreMatches() {
            generateMatches(20); 
            const m = state.schedule[state.currentIdx];
            if(m && m.status === 'finished') {
                const firstNew = state.schedule.findIndex(x => x.status === 'pending');
                if(firstNew !== -1) state.currentIdx = firstNew;
            }
            saveData();
            syncUI();
        }

        function clearData() {
            showModal("é‡ç½®è­¦å‘Š", "ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³½ç¨‹èˆ‡åˆ†æ•¸å—ï¼Ÿ<br>(åå–®æœƒä¿ç•™)", () => {
                state.schedule = [];
                state.currentIdx = 0;
                saveData();
                syncUI();
            });
        }

        function renderSchedule() {
            const div = document.getElementById('schedule-container');
            if(!state.schedule.length) { div.innerHTML = ''; return; }

            div.innerHTML = state.schedule.map((m, i) => {
                const isCur = i === state.currentIdx;
                const activeClass = isCur ? 'active' : '';
                const finishedClass = m.status === 'finished' ? 'finished' : '';
                let scoreDisplay = `<span style="color:#666; font-size:0.8rem;">æœªé–‹å§‹</span>`;
                if(m.status === 'active') scoreDisplay = `<span style="color:var(--accent); font-weight:bold;">é€²è¡Œä¸­</span>`;
                if(m.status === 'finished') scoreDisplay = `${m.s1} : ${m.s2}`;
                
                const t1Style = (m.status==='finished' && m.s1 > m.s2) ? 'color:var(--accent); font-weight:bold;' : '';
                const t2Style = (m.status==='finished' && m.s2 > m.s1) ? 'color:var(--accent); font-weight:bold;' : '';

                return `
                    <div class="match-card ${activeClass} ${finishedClass}" onclick="jumpToMatch(${i})">
                        <div style="width:25px; color:#666; font-size:0.8rem;">#${m.id}</div>
                        <div style="flex:1; text-align:right; ${t1Style}">${m.t1[0]}<br>${m.t1[1]}</div>
                        <div style="margin:0 15px; text-align:center;">
                            <div class="score-badge">${scoreDisplay}</div>
                        </div>
                        <div style="flex:1; text-align:left; ${t2Style}">${m.t2[0]}<br>${m.t2[1]}</div>
                    </div>
                `;
            }).join('');
            
            setTimeout(() => {
                const el = document.querySelector('.match-card.active');
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function jumpToMatch(idx) {
            if(state.currentIdx === idx) return;
            state.currentIdx = idx;
            saveData();
            syncUI();
        }

        function openFullscreen() {
            document.getElementById('fs-overlay').classList.add('show');
            const elem = document.documentElement;
            if (elem.requestFullscreen) elem.requestFullscreen().catch(()=>{});
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
            requestWakeLock();
        }

        function closeFullscreen() {
            document.getElementById('fs-overlay').classList.remove('show');
            if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }

        function showModal(title, msg, callback) {
            if(isModalOpen) return;
            isModalOpen = true;
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerHTML = msg;
            const btn = document.getElementById('modal-confirm-btn');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => { closeModal(); callback(); };
            document.getElementById('custom-modal').classList.add('show');
        }
        function closeModal() {
            document.getElementById('custom-modal').classList.remove('show');
            setTimeout(() => { isModalOpen = false; }, 200);
        }
    </script>
</body>
</html>
