<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾½çƒé›™æ‰“æ’ç¨‹èˆ‡è¨ˆåˆ†</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root {
            --primary: #2c3e50;
            --accent: #27ae60; /* ç¶ è‰² */
            --danger: #e74c3c; /* ç´…è‰² */
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #333;
            --modal-bg: rgba(0, 0, 0, 0.6);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh; /* æ‰‹æ©Ÿç€è¦½å™¨å„ªåŒ– */
            display: flex;
            flex-direction: column;
            color: var(--text);
            overflow: hidden;
        }

        button {
            cursor: pointer;
            border: none;
            outline: none;
            font-family: inherit;
            font-weight: bold;
            transition: transform 0.1s, opacity 0.1s;
            user-select: none;
        }
        button:active { transform: scale(0.96); opacity: 0.9; }

        /* --- è‡ªè¨‚å½ˆè·³è¦–çª— (Modal) --- */
        .modal-overlay {
            display: none; /* é è¨­éš±è— */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
        
        .modal-card {
            background: white;
            width: 85%;
            max-width: 320px;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-title { font-size: 1.4rem; font-weight: 900; color: var(--primary); margin-bottom: 10px; }
        .modal-msg { font-size: 1rem; color: #555; margin-bottom: 20px; line-height: 1.5; }
        
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 1rem; }
        .btn-cancel { background: #eee; color: #666; }
        .btn-confirm { background: var(--accent); color: white; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }


        /* --- è¨­å®šé é¢ --- */
        .page {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 100%;
        }

        #setup-page {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
        }
        
        .setup-card {
            background: var(--card);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
            margin-top: 20px;
        }

        input {
            width: 100%; padding: 12px; font-size: 1rem;
            border: 2px solid #ddd; border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .player-tag {
            display: inline-flex;
            align-items: center;
            background: #e9ecef;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 1rem;
        }
        .player-tag span { color: #999; margin-left: 8px; cursor: pointer; font-size: 1.2rem; }

        /* è³½åˆ¶é¸æ“‡ Radio Button */
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .mode-label {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .mode-label input { display: none; }
        .mode-label.selected {
            background: #e8f5e9;
            border-color: var(--accent);
            color: var(--accent);
            font-weight: bold;
        }

        /* --- ä¸»æ‡‰ç”¨é é¢ä½ˆå±€ --- */
        #app-page {
            display: none;
            flex-direction: column;
            padding: 0; /* æ»¿ç‰ˆè¨­è¨ˆ */
            max-width: 100%;
            height: 100%;
            background: #222;
        }

        /* ä¸ŠåŠéƒ¨ï¼šè¨ˆåˆ†æ¿ (ä½”æ“šæ‰€æœ‰å‰©é¤˜ç©ºé–“) */
        .scoreboard-section {
            flex: 1; /* è‡ªå‹•å¡«æ»¿ç©ºé–“ */
            background: var(--card);
            border-radius: 0 0 30px 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; /* å…§å®¹å‚ç›´å‡åˆ† */
            padding: 15px;
            position: relative;
            z-index: 10;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            overflow-y: auto;
        }

        .match-info-bar {
            text-align: center;
            color: #888;
            font-size: 1rem;
            border-bottom: 1px solid #f5f5f5;
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .target-score-badge {
            background: #eee;
            color: #666;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* æ¯”åˆ†æ ¸å¿ƒå€åŸŸ */
        .scores-display {
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex: 1;
            margin-bottom: 10px;
        }

        .team-block {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        /* é¸æ‰‹åå­— */
        .team-names {
            font-size: 1.5rem; 
            font-weight: 900;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            line-height: 1.2;
            min-height: 1.5em; /* èª¿æ•´é«˜åº¦é©æ‡‰å–®è¡Œ */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-direction: column;
            word-break: break-word; /* é˜²æ­¢åå­—éé•· */
            padding: 0 5px;
        }

        .score-number {
            font-size: clamp(4rem, 15vh, 8rem);
            line-height: 1;
            font-weight: 800;
            color: var(--primary);
            margin: 5px 0 15px 0;
            font-variant-numeric: tabular-nums;
            cursor: pointer;
        }

        .score-controls {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .btn-control {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            color: white;
        }
        .btn-minus { background-color: var(--danger); }
        .btn-plus { background-color: var(--accent); }

        .vs-text {
            font-size: 1.5rem;
            color: #e0e0e0;
            font-weight: 900;
            margin: 0 10px;
            font-style: italic;
            align-self: center;
        }

        /* ä¸‹ä¸€å ´æŒ‰éˆ•å€ */
        .next-match-area {
            margin-top: auto;
            padding-top: 15px;
        }
        .btn-finish {
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.4);
        }

        /* ä¸‹åŠéƒ¨ï¼šè³½ç¨‹åˆ—è¡¨ (Fixed Height) */
        .schedule-section {
            height: 30vh;
            min-height: 180px;
            flex: none;
            background: #f0f2f5;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 5px;
            color: #666;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .schedule-list {
            flex: 1;
        }

        .match-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            font-size: 1rem;
            border-left: 5px solid transparent;
        }
        .match-card.active {
            border-left-color: var(--accent);
            background: #fff;
        }
        .match-card.finished {
            opacity: 0.6;
            background: #e9ecef;
            color: #888;
        }

        .score-badge {
            background: #eee;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #555;
            min-width: 60px;
            text-align: center;
            font-size: 0.9rem;
        }
        .active .score-badge {
            background: var(--accent);
            color: white;
        }

        /* å·¥å…·é¡ */
        .btn-green { background: var(--accent); color: white; border-radius: 8px; padding: 10px 20px; }
        .btn-outline { border: 1px solid #aaa; background: white; color: #555; border-radius: 6px; padding: 5px 12px; font-size: 0.85rem; }

    </style>
</head>
<body>

    <!-- è‡ªè¨‚å½ˆè·³è¦–çª— -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title" id="modal-title">æ¨™é¡Œ</div>
            <div class="modal-msg" id="modal-msg">å…§å®¹</div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ (ç¹¼çºŒæ‰“)</button>
                <button class="modal-btn btn-confirm" id="modal-confirm-btn">ç¢ºå®šä¸‹ä¸€å ´</button>
            </div>
        </div>
    </div>

    <!-- 1. è¨­å®šé é¢ -->
    <div id="setup-page" class="page">
        <div class="setup-card">
            <h2 style="margin-bottom: 20px; color: var(--primary);">ğŸ¸ ç¾½çƒé›™æ‰“æ’ç¨‹</h2>
            
            <!-- è³½åˆ¶é¸æ“‡ -->
            <div style="text-align:center; margin-bottom:5px; color:#666; font-size:0.9rem;">é¸æ“‡è³½åˆ¶</div>
            <div class="mode-selector">
                <label class="mode-label selected" onclick="selectMode(21, this)">
                    21åˆ†åˆ¶
                    <input type="radio" name="mode" value="21" checked>
                </label>
                <label class="mode-label" onclick="selectMode(11, this)">
                    11åˆ†åˆ¶
                    <input type="radio" name="mode" value="11">
                </label>
            </div>

            <p style="color:#666; font-size:0.9rem; margin-top:10px;">åƒåŠ äººå“¡åå–®</p>
            
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="input-name" placeholder="è¼¸å…¥åå­— (æŒ‰Enteræ–°å¢)" autocomplete="off">
                <button class="btn-green" onclick="addPlayer()">æ–°å¢</button>
            </div>

            <div id="player-list" style="margin-bottom:20px; min-height: 50px;">
                <!-- JS æ¸²æŸ“ -->
            </div>

            <button class="btn-green" style="width:100%; padding:15px; font-size:1.1rem; margin-bottom:15px;" onclick="startSystem()">
                é–‹å§‹æ’ç¨‹æ¯”è³½
            </button>
            
            <div style="text-align:center;">
                <button class="btn-outline" onclick="clearData()">æ¸…é™¤è³‡æ–™é‡ç½®</button>
            </div>
        </div>
    </div>

    <!-- 2. ä¸»æ‡‰ç”¨é é¢ (è¨ˆåˆ†æ¿ + è³½ç¨‹) -->
    <div id="app-page">
        
        <!-- ä¸Šæ–¹ï¼šè¶…å¤§è¨ˆåˆ†æ¿ (Flex 1) -->
        <div class="scoreboard-section">
            <div class="match-info-bar">
                ç¬¬ <span id="match-id" style="font-weight:bold; color:var(--primary);">1</span> å ´
                <span id="target-score-display" class="target-score-badge">21åˆ†åˆ¶</span>
            </div>

            <div class="scores-display">
                <!-- å·¦éšŠ -->
                <div class="team-block">
                    <div class="team-names" id="t1-names"></div>
                    <div class="score-number" id="t1-score" onclick="updateScore(1, 1)">0</div>
                    <div class="score-controls">
                        <button class="btn-control btn-minus" onclick="updateScore(1, -1)">-</button>
                        <button class="btn-control btn-plus" onclick="updateScore(1, 1)">+</button>
                    </div>
                </div>

                <div class="vs-text">VS</div>

                <!-- å³éšŠ -->
                <div class="team-block">
                    <div class="team-names" id="t2-names"></div>
                    <div class="score-number" id="t2-score" onclick="updateScore(2, 1)">0</div>
                    <div class="score-controls">
                        <button class="btn-control btn-minus" onclick="updateScore(2, -1)">-</button>
                        <button class="btn-control btn-plus" onclick="updateScore(2, 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="next-match-area">
                <!-- æ‰‹å‹•çµæŸæŒ‰éˆ• -->
                <button class="btn-finish" onclick="manualFinishClick()">
                    çµæŸæœ¬å ´ (ä¸‹ä¸€å ´) â”
                </button>
            </div>
        </div>

        <!-- ä¸‹æ–¹ï¼šè³½ç¨‹åˆ—è¡¨ (Fixed Height) -->
        <div class="schedule-section">
            <div class="schedule-header">
                <span>è³½ç¨‹è¡¨</span>
                <div>
                    <!-- ä¿®æ”¹é€™è£¡ï¼šå°‡ backToSetup æ”¹ç‚º clearDataï¼Œä¸¦åŠ ä¸Šç´…è‰²æ¨£å¼æé†’ -->
                    <button class="btn-outline" onclick="clearData()" style="color: var(--danger); border-color: var(--danger);">å…¨éƒ¨é‡ç½®</button>
                    <button class="btn-outline" onclick="addMoreMatches()">+ ç”¢ç”Ÿ</button>
                </div>
            </div>
            
            <div class="schedule-list" id="schedule-container">
                <!-- JS æ¸²æŸ“ -->
            </div>
        </div>

    </div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™ ---
        const DEFAULT_STATE = {
            players: [],
            schedule: [],
            currentIdx: 0,
            partnerships: {},
            targetScore: 21
        };

        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        let tempTargetScore = 21;
        let isModalOpen = false; // é˜²æ­¢é‡è¤‡é–‹å•Ÿ

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderPlayers();
            updateModeUI();
            
            document.getElementById('input-name').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addPlayer();
            });

            if(state.schedule.length > 0) {
                showApp();
            }
        });

        // --- å½ˆçª—ç³»çµ± (æ ¸å¿ƒä¿®å¾©) ---
        function showModal(title, msg, confirmCallback) {
            if(isModalOpen) return; // é˜²æ­¢é‡è¤‡è·³çª—
            isModalOpen = true;
            
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerHTML = msg; // å…è¨± HTML (æ›è¡Œ)
            
            const confirmBtn = document.getElementById('modal-confirm-btn');
            // ç§»é™¤èˆŠçš„ event listener é¿å…ç–ŠåŠ ï¼Œæœ€ç°¡å–®æ˜¯ç”¨ cloneNode
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            
            newBtn.onclick = () => {
                closeModal();
                confirmCallback();
            };

            document.getElementById('custom-modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('custom-modal').classList.remove('show');
            // å»¶é²ä¸€ä¸‹å†é‡‹æ”¾é–ï¼Œé¿å…èª¤è§¸
            setTimeout(() => { isModalOpen = false; }, 300);
        }

        // --- è¨­å®šé é¢åŠŸèƒ½ ---
        function selectMode(score, element) {
            tempTargetScore = score;
            document.querySelectorAll('.mode-label').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            const radio = element.querySelector('input');
            if(radio) radio.checked = true;
        }

        function updateModeUI() {
            const savedScore = state.targetScore || 21;
            tempTargetScore = savedScore;
            const radios = document.getElementsByName('mode');
            radios.forEach(r => {
                if(parseInt(r.value) === savedScore) {
                    r.checked = true;
                    r.parentElement.classList.add('selected');
                } else {
                    r.parentElement.classList.remove('selected');
                }
            });
        }

        function addPlayer() {
            const input = document.getElementById('input-name');
            const name = input.value.trim();
            if(!name) return;
            if(state.players.find(p => p.name === name)) { alert('åå­—é‡è¤‡å›‰'); return; }
            state.players.push({ name, played: 0 });
            input.value = '';
            saveData();
            renderPlayers();
        }

        function renderPlayers() {
            const div = document.getElementById('player-list');
            if(state.players.length === 0) {
                div.innerHTML = '<p style="color:#999; padding:10px;">ç›®å‰æ²’æœ‰äººå“¡ï¼Œè«‹æ–°å¢</p>';
                return;
            }
            div.innerHTML = state.players.map((p, i) => `
                <div class="player-tag">${p.name} <span onclick="removePlayer(${i})">Ã—</span></div>
            `).join('');
        }

        function removePlayer(idx) {
            state.players.splice(idx, 1);
            saveData();
            renderPlayers();
        }

        function startSystem() {
            if(state.players.length < 4) { alert('è‡³å°‘éœ€è¦4äºº'); return; }
            state.targetScore = tempTargetScore;
            if(state.schedule.length === 0) {
                state.partnerships = {};
                generateMatches(10);
            }
            saveData();
            showApp();
        }

        // --- æ’ç¨‹é‚è¼¯ ---
        function generateMatches(count) {
            const startId = state.schedule.length + 1;
            for(let i=0; i<count; i++) {
                let pool = [...state.players];
                pool.sort((a, b) => (a.played - b.played) || (Math.random() - 0.5));
                const picked = pool.slice(0, 4);
                picked.forEach(p => {
                    const realP = state.players.find(x => x.name === p.name);
                    if(realP) realP.played++;
                });

                const combos = [
                    { t1: [picked[0], picked[1]], t2: [picked[2], picked[3]] },
                    { t1: [picked[0], picked[2]], t2: [picked[1], picked[3]] },
                    { t1: [picked[0], picked[3]], t2: [picked[1], picked[2]] }
                ];
                combos.forEach(c => {
                    c.w = getPartnerCount(c.t1[0].name, c.t1[1].name) + 
                          getPartnerCount(c.t2[0].name, c.t2[1].name);
                });
                combos.sort((a, b) => a.w - b.w || (Math.random() - 0.5));
                const best = combos[0];

                addPartnerCount(best.t1[0].name, best.t1[1].name);
                addPartnerCount(best.t2[0].name, best.t2[1].name);

                state.schedule.push({
                    id: startId + i,
                    t1: [best.t1[0].name, best.t1[1].name],
                    t2: [best.t2[0].name, best.t2[1].name],
                    s1: 0, s2: 0, status: 'pending'
                });
            }
            saveData();
            renderSchedule();
        }

        function getPartnerCount(n1, n2) {
            return state.partnerships[[n1, n2].sort().join('|')] || 0;
        }
        function addPartnerCount(n1, n2) {
            const k = [n1, n2].sort().join('|');
            state.partnerships[k] = (state.partnerships[k] || 0) + 1;
        }

        // --- App é é¢é‚è¼¯ ---
        function showApp() {
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'flex';
            
            // å°‹æ‰¾ä¸‹ä¸€å ´
            let idx = state.schedule.findIndex(m => m.status !== 'finished');
            if(idx === -1) {
                generateMatches(5);
                idx = state.schedule.findIndex(m => m.status !== 'finished');
            }
            state.currentIdx = idx;
            
            if(state.schedule[idx].status === 'pending') state.schedule[idx].status = 'active';
            
            updateScoreUI();
            renderSchedule();
        }

        function updateScoreUI() {
            const m = state.schedule[state.currentIdx];
            if(!m) return;

            const target = state.targetScore || 21;
            document.getElementById('match-id').innerText = m.id;
            document.getElementById('target-score-display').innerText = `${target}åˆ†åˆ¶`;

            // ä¿®æ”¹é€™è£¡ï¼šç”¨æ–œç·šåˆ†éš”ä¸¦åœ¨åŒä¸€è¡Œé¡¯ç¤º
            document.getElementById('t1-names').innerText = `${m.t1[0]} / ${m.t1[1]}`;
            document.getElementById('t2-names').innerText = `${m.t2[0]} / ${m.t2[1]}`;
            
            document.getElementById('t1-score').innerText = m.s1;
            document.getElementById('t2-score').innerText = m.s2;
        }

        function updateScore(team, delta) {
            // å¦‚æœ Modal é–‹è‘—ï¼Œä¸å…è¨±åŠ åˆ†ï¼Œé˜²æ­¢æ··äº‚
            if (isModalOpen) return;

            const currentIdx = state.currentIdx;
            const m = state.schedule[currentIdx];
            if(!m || m.status === 'finished') return;

            if(team === 1) m.s1 = Math.max(0, m.s1 + delta);
            else m.s2 = Math.max(0, m.s2 + delta);
            
            document.getElementById('t1-score').innerText = m.s1;
            document.getElementById('t2-score').innerText = m.s2;
            saveData();
            renderSchedule(); 

            // è‡ªå‹•åˆ¤å®š
            const target = state.targetScore || 21;
            if ((m.s1 >= target || m.s2 >= target) && m.status !== 'finished') {
                // é”åˆ°åˆ†æ•¸ï¼Œç›´æ¥çµæŸæ›ä¸‹ä¸€å ´ (ä¸éœ€ç¢ºèª)
                finishMatch(currentIdx);
            }
        }

        // æ‰‹å‹•é»æ“ŠæŒ‰éˆ•
        function manualFinishClick() {
            const m = state.schedule[state.currentIdx];
            if (!m || m.status === 'finished') return;
            
            // æ‰‹å‹•é»æ“Šï¼Œç›´æ¥çµæŸæ›ä¸‹ä¸€å ´ (ä¸éœ€ç¢ºèª)
            finishMatch(state.currentIdx);
        }

        function finishMatch(idx) {
            const m = state.schedule[idx];
            if (!m) return;

            m.status = 'finished';
            saveData();
            showApp(); // é‡æ–°è¼‰å…¥ä»¥é¡¯ç¤ºä¸‹ä¸€å ´
        }

        function renderSchedule() {
            const div = document.getElementById('schedule-container');
            div.innerHTML = state.schedule.map((m, i) => {
                const isCur = i === state.currentIdx;
                const activeClass = isCur ? 'active' : '';
                const finishedClass = m.status === 'finished' ? 'finished' : '';
                const scoreText = m.status === 'pending' ? 'vs' : `${m.s1}:${m.s2}`;
                const scoreStyle = m.status === 'pending' ? 'color:#ccc' : 'color:#333';
                
                // ä¿®æ”¹é€™è£¡ï¼šåˆ—è¡¨ä¸­çš„åå­—ä¹Ÿæ”¹æˆç”¨æ–œç·šåˆ†éš”
                return `
                    <div class="match-card ${activeClass} ${finishedClass}" id="match-${i}">
                        <div style="width:30px; color:#999; font-size:0.9rem;">${m.id}</div>
                        <div style="flex:1; text-align:right; font-weight:500;">${m.t1[0]} / ${m.t1[1]}</div>
                        <div style="margin:0 12px; ${scoreStyle}" class="score-badge">${scoreText}</div>
                        <div style="flex:1; text-align:left; font-weight:500;">${m.t2[0]} / ${m.t2[1]}</div>
                    </div>
                `;
            }).join('');

            setTimeout(() => {
                const el = document.querySelector('.match-card.active');
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function addMoreMatches() {
            generateMatches(5);
            renderSchedule();
        }

        function backToSetup() {
            // ç”¨æˆ‘å€‘çš„æ–° Modal
            showModal("è¿”å›è¨­å®š", "é€™å¯èƒ½æœƒæ‰“äº‚ç›®å‰çš„æ’ç¨‹é †åºï¼Œç¢ºå®šè¦å›å»å—ï¼Ÿ", () => {
                document.getElementById('app-page').style.display = 'none';
                document.getElementById('setup-page').style.display = 'flex';
                updateModeUI();
            });
        }

        function clearData() {
            showModal("è­¦å‘Š", "é€™æœƒåˆªé™¤æ‰€æœ‰åå–®å’Œå°æˆ°ç´€éŒ„ï¼Œç¢ºå®šé‡ä¾†ï¼Ÿ", () => {
                // 1. æ¸…é™¤ LocalStorage
                localStorage.removeItem('badminton_v3');
                
                // 2. é‡ç½®æ‰€æœ‰è®Šæ•¸å›é è¨­å€¼
                state = JSON.parse(JSON.stringify(DEFAULT_STATE));
                
                // 3. è¦–è¦ºä¸Šåˆ‡æ›å›è¨­å®šé é¢
                document.getElementById('app-page').style.display = 'none';
                document.getElementById('setup-page').style.display = 'flex';
                
                // 4. æ¸…ç©ºä»‹é¢ä¸Šçš„è³‡æ–™
                document.getElementById('input-name').value = '';
                document.getElementById('schedule-container').innerHTML = '';
                
                // 5. é‡ç¹ªè¨­å®šé  (åå–®æœƒè®Šç©ºã€åˆ†æ•¸é‡ç½®)
                renderPlayers();
                updateModeUI();
            });
        }

        function saveData() {
            localStorage.setItem('badminton_v3', JSON.stringify(state));
        }
        function loadData() {
            const d = localStorage.getItem('badminton_v3');
            if(d) try { state = JSON.parse(d); } catch(e){}
        }

    </script>
</body>
</html>
