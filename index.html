<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / Mobile Web App è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <title>ç¾½çƒæ’ç¨‹ v5 (Global)</title>
    
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/zxuan-c/badminton-partner-v4/refs/heads/main/icon2.jpg">

    <!-- Supabase SDK (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root {
            --primary: #2c3e50;
            --accent: #27ae60; /* ç¶ è‰² */
            --danger: #e74c3c; /* ç´…è‰² */
            --warning: #f1c40f; /* é»ƒè‰² */
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #333;
            --modal-bg: rgba(0, 0, 0, 0.7);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            height: 100vh; height: 100dvh;
            display: flex; flex-direction: column;
            color: var(--text);
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        button {
            cursor: pointer; border: none; outline: none;
            font-family: inherit; font-weight: bold;
            transition: transform 0.1s, opacity 0.1s, filter 0.1s;
        }
        button:active { transform: scale(0.96); opacity: 0.9; }

        /* --- å…¨è¢å¹•è¨ˆåˆ†æ¨¡å¼ --- */
        #fs-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100svh;
            background: #000; z-index: 2000;
            flex-direction: column; color: white;
            padding-top: max(env(safe-area-inset-top), 10px);
            padding-bottom: max(env(safe-area-inset-bottom), 10px);
        }
        #fs-overlay.show { display: flex; }

        .fs-close-btn {
            position: absolute; top: max(env(safe-area-inset-top), 20px); right: 20px;
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(255,255,255,0.15); color: white;
            font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
            z-index: 2001; backdrop-filter: blur(5px);
        }

        /* ç‚ºäº†æ–¹ä¾¿å°é¢çš„äººçœ‹ï¼Œé è¨­ flex-direction: row-reverse */
        .fs-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            padding: 0 10px; width: 100%; height: 100%; overflow: hidden;
            flex-direction: row-reverse; 
        }

        .fs-team {
            flex: 1; height: 100%; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }

        /* ç”¨æ–¼é¡¯ç¤ºç•¶å‰ç™¼çƒæ–¹/å¾—åˆ†æ–¹çš„èƒŒæ™¯å…‰æšˆ */
        .fs-team.serving::before {
            content: ''; position: absolute;
            width: 80%; height: 60%;
            background: radial-gradient(circle, rgba(39, 174, 96, 0.2) 0%, rgba(0,0,0,0) 70%);
            z-index: -1; opacity: 1; transition: opacity 0.3s;
        }

        .fs-names {
            font-size: clamp(1.5rem, 6vmin, 3rem); color: #bbb;
            text-align: center; margin-bottom: 1vh; font-weight: 700;
            line-height: 1.2; padding: 0 10px; word-break: break-word;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .fs-score {
            font-size: 40vmin; font-weight: 800; color: white;
            line-height: 0.9; margin-bottom: 2vh;
            font-variant-numeric: tabular-nums; cursor: pointer;
            text-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .fs-score.winner { color: var(--accent); text-shadow: 0 0 30px rgba(39, 174, 96, 0.6); }

        .fs-controls { display: flex; gap: 30px; }

        .fs-btn {
            width: 12vmin; height: 12vmin;
            min-width: 60px; min-height: 60px;
            border-radius: 50%; font-size: 2rem;
            display: flex; align-items: center; justify-content: center;
            color: white; backdrop-filter: blur(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .fs-btn.minus { background: rgba(231, 76, 60, 0.2); border: 2px solid var(--danger); }
        .fs-btn.plus { background: rgba(39, 174, 96, 0.2); border: 2px solid var(--accent); }

        .fs-divider {
            width: 2px; height: 60%; background: #333;
            margin: 0 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .fs-divider::after {
            content: 'â‡„'; color: #555; font-size: 2rem; background: #000; padding: 10px;
        }

        /* --- å½ˆè·³è¦–çª— (Modal) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 9999;
            justify-content: center; align-items: center; backdrop-filter: blur(3px);
        }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
        
        .modal-card {
            background: white; width: 85%; max-width: 320px; padding: 25px;
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-title { font-size: 1.4rem; font-weight: 900; color: var(--primary); margin-bottom: 10px; }
        .modal-msg { font-size: 1rem; color: #555; margin-bottom: 25px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 12px; font-size: 1rem; }
        .btn-cancel { background: #f1f3f5; color: #666; }
        .btn-confirm { background: var(--accent); color: white; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- é é¢å®¹å™¨ --- */
        .page {
            flex: 1; display: flex; flex-direction: column;
            padding: 15px; width: 100%; max-width: 600px;
            margin: 0 auto; height: 100%;
        }

        #setup-page { display: none; overflow-y: auto; }
        
        .setup-card {
            background: var(--card); padding: 30px 25px; border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%;
        }

        input {
            width: 100%; padding: 15px; font-size: 1.1rem;
            border: 2px solid #eee; border-radius: 12px; margin-bottom: 15px;
            background: #f9f9f9; -webkit-appearance: none; outline: none;
        }
        input:focus { border-color: var(--accent); background: white; }
        
        .player-tag {
            display: inline-flex; align-items: center; background: #fff;
            padding: 8px 16px; border-radius: 30px; margin: 5px;
            font-size: 1rem; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .player-tag span { 
            color: #bbb; margin-left: 10px; cursor: pointer; 
            font-size: 1.2rem; width: 20px; height: 20px; text-align: center; line-height: 20px;
        }
        .player-tag span:hover { color: var(--danger); }

        /* ç§»é™¤ Mode Selector */
        /* .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; } */

        /* --- ä¸»æ‡‰ç”¨é é¢ (è¨ˆåˆ†æ¿) --- */
        #app-page {
            display: none; flex-direction: column; padding: 0;
            max-width: 100%; height: 100%; background: #1a1a1a;
        }

        .scoreboard-section {
            flex: 1; background: white;
            border-radius: 0 0 40px 40px;
            display: flex; flex-direction: column;
            padding: 15px 20px 25px 20px;
            position: relative; z-index: 10;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow-y: auto;
        }

        .match-info-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; color: #888; font-size: 0.95rem;
        }
        .match-badge { background: #f0f2f5; padding: 4px 10px; border-radius: 6px; font-weight: 600; color: #555; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-right: 5px; display:inline-block;}
        .status-dot.online { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

        .scores-display {
            display: flex; align-items: center; justify-content: space-between;
            flex: 1; margin-bottom: 10px;
        }

        .team-block {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 100%;
        }

        .team-names {
            font-size: 1.4rem; font-weight: 800; text-align: center;
            color: #2c3e50; margin-bottom: 10px; min-height: 3.2rem;
            display: flex; flex-direction: column; justify-content: flex-end;
            line-height: 1.1;
        }

        .score-number {
            font-size: clamp(5rem, 18vh, 9rem); line-height: 0.9;
            font-weight: 800; color: var(--primary); margin: 5px 0 20px 0;
            font-variant-numeric: tabular-nums; cursor: pointer;
            transition: color 0.2s;
        }
        .score-number.winner { color: var(--accent); }

        .score-controls { display: flex; gap: 15px; }

        .btn-control {
            width: 60px; height: 60px; border-radius: 20px;
            font-size: 1.8rem; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); color: white;
            position: relative; overflow: hidden;
        }
        .btn-control::after {
            content:''; position: absolute; width:100%; height:100%; 
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
        }
        .btn-minus { background-color: var(--danger); }
        .btn-plus { background-color: var(--accent); }

        .vs-column {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 5px; opacity: 0.5;
        }
        .vs-text { font-size: 1.2rem; font-weight: 900; font-style: italic; color: #ccc; margin-bottom: 10px;}
        .btn-swap { font-size: 1.5rem; color: #999; padding: 10px; background: #f8f9fa; border-radius: 50%; }

        .next-match-area {
            margin-top: auto; padding-top: 10px; display: flex; gap: 10px;
        }
        .btn-finish {
            flex: 2; background: var(--primary); color: white;
            padding: 18px; font-size: 1.1rem; font-weight: bold; border-radius: 16px;
            box-shadow: 0 8px 20px rgba(44, 62, 80, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-prev {
            flex: 1; background: #fff; color: #666; border: 2px solid #eee;
            padding: 15px; font-size: 1rem; font-weight: bold; border-radius: 16px;
        }

        /* --- è³½ç¨‹è¡¨å€å¡Š --- */
        .schedule-section {
            height: 35vh; min-height: 200px; flex: none;
            background: #1a1a1a; padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .schedule-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; color: #666;
        }
        .schedule-title { color: #888; font-weight: bold; font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase;}

        .match-card {
            background: #2a2a2a; border-radius: 12px; padding: 14px;
            margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
            color: #eee; border-left: 4px solid #444; transition: all 0.3s;
        }
        .match-card.active { border-left-color: var(--accent); background: #333; transform: translateX(5px); }
        .match-card.finished { opacity: 0.5; }
        
        .score-badge {
            background: #444; padding: 4px 12px; border-radius: 6px;
            font-weight: bold; color: #aaa; min-width: 65px; text-align: center;
            font-family: monospace; font-size: 1rem;
        }
        .active .score-badge { background: var(--accent); color: white; }

        /* --- å…±ç”¨æŒ‰éˆ•èˆ‡å·¥å…· --- */
        .btn-green { background: var(--accent); color: white; border-radius: 12px; padding: 12px 20px; font-weight: bold; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3); }
        .btn-icon { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 8px; color: #fff; }
        .toolbar { display: flex; gap: 10px; }
        .toolbar button { background: #333; color: #ccc; border: 1px solid #444; border-radius: 8px; padding: 6px 12px; font-size: 0.8rem; }
        
        .spinning { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* è¼‰å…¥é®ç½© */
        #global-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
    </style>
</head>
<body>

    <!-- Global Loader -->
    <div id="global-loader">
        <div style="font-size: 4rem; margin-bottom: 20px;" class="spinning">ğŸ¸</div>
        <div style="color:#666; font-weight:bold;">æ­£åœ¨é€£ç·šåˆ°ç¾½çƒæ’ç¨‹...</div>
    </div>

    <!-- å…¨è¢å¹•è¨ˆåˆ†æ¨¡å¼ -->
    <div id="fs-overlay">
        <button class="fs-close-btn" onclick="closeFullscreen()">âœ•</button>
        <div class="fs-container">
            <!-- é€™è£¡ç”¨ row-reverse æ˜¯ç‚ºäº†è®“ç«™åœ¨å°é¢çš„äººçœ‹åˆ°æ­£ç¢ºçš„æ–¹ä½ -->
            <div class="fs-team" id="fs-t1-box">
                <div class="fs-names" id="fs-t1-names">Team 1</div>
                <div class="fs-score" id="fs-t1-score" onclick="updateScore(1, 1)">0</div>
                <div class="fs-controls">
                    <button class="fs-btn minus" onclick="updateScore(1, -1)">-</button>
                    <button class="fs-btn plus" onclick="updateScore(1, 1)">+</button>
                </div>
            </div>
            
            <div class="fs-divider" onclick="swapTeams()" title="äº¤æ›å ´åœ°"></div>

            <div class="fs-team" id="fs-t2-box">
                <div class="fs-names" id="fs-t2-names">Team 2</div>
                <div class="fs-score" id="fs-t2-score" onclick="updateScore(2, 1)">0</div>
                <div class="fs-controls">
                    <button class="fs-btn minus" onclick="updateScore(2, -1)">-</button>
                    <button class="fs-btn plus" onclick="updateScore(2, 1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å½ˆè·³è¦–çª— -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-msg" id="modal-msg"></div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" id="modal-confirm-btn">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- 1. è¨­å®šé é¢ (é¦–é ) -->
    <div id="setup-page" class="page">
        <div class="setup-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h2 style="color: var(--primary); margin:0;">ç¾½çƒæ’ç¨‹ (Global)</h2>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="status-dot" id="connection-dot-setup" style="margin-right:0;"></span>
                    <button class="btn-icon" onclick="refreshData()" style="color:#888; background:transparent;">ğŸ”„</button>
                </div>
            </div>
            
            <!-- ç›®æ¨™åˆ†æ•¸ (å›ºå®šé¡¯ç¤º) -->
            <div style="background:#f9f9f9; padding:15px; border-radius:12px; text-align:center; margin-bottom:20px; color:#666;">
                è³½åˆ¶ï¼š<strong style="color:var(--primary);">11åˆ†åˆ¶</strong>
            </div>

            <label style="display:block; color:#888; font-size:0.9rem; margin-bottom:8px;">çƒå“¡åå–® (ç”±ä¸Šå ´æ¬¡æ•¸è‡ªå‹•æ’åº)</label>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="input-name" placeholder="è¼¸å…¥åå­—..." autocomplete="off" style="margin-bottom:0;">
                <button class="btn-green" onclick="addPlayer()" style="width:80px;">+</button>
            </div>

            <div id="player-list" style="margin-bottom:30px; min-height: 60px; display:flex; flex-wrap:wrap;"></div>

            <button class="btn-green" style="width:100%; padding:16px; font-size:1.1rem; margin-bottom:15px;" onclick="startSystem()">
                é–‹å§‹ / ç¹¼çºŒæ¯”è³½
            </button>
        </div>
    </div>

    <!-- 2. ä¸»æ‡‰ç”¨é é¢ (è¨ˆåˆ†æ¿) -->
    <div id="app-page">
        <div class="scoreboard-section">
            <div class="match-info-bar">
                <div style="display:flex; align-items:center;">
                    <span class="status-dot" id="connection-dot-app"></span>
                    <span class="match-badge">Match <span id="match-id">1</span></span>
                    <span class="match-badge" style="margin-left:5px; background:#fff; border:1px solid #eee;" id="target-score-display">11</span>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn-icon" onclick="refreshData()" style="color:#888; background:transparent; font-size:1.2rem;">ğŸ”„</button>
                    <button style="background:var(--primary); color:white; padding:5px 12px; border-radius:15px; font-size:0.8rem; display:flex; align-items:center; gap:5px;" onclick="openFullscreen()">
                        â›¶ å…¨è¢å¹•
                    </button>
                </div>
            </div>

            <div class="scores-display">
                <div class="team-block">
                    <div class="team-names" id="t1-names"></div>
                    <div class="score-number" id="t1-score" onclick="updateScore(1, 1)">0</div>
                    <div class="score-controls">
                        <button class="btn-control btn-minus" onclick="updateScore(1, -1)">-</button>
                        <button class="btn-control btn-plus" onclick="updateScore(1, 1)">+</button>
                    </div>
                </div>
                
                <div class="vs-column">
                    <div class="vs-text">VS</div>
                    <button class="btn-swap" onclick="swapTeams()" title="äº¤æ›å ´åœ°">â‡„</button>
                </div>

                <div class="team-block">
                    <div class="team-names" id="t2-names"></div>
                    <div class="score-number" id="t2-score" onclick="updateScore(2, 1)">0</div>
                    <div class="score-controls">
                        <button class="btn-control btn-minus" onclick="updateScore(2, -1)">-</button>
                        <button class="btn-control btn-plus" onclick="updateScore(2, 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="next-match-area">
                <button class="btn-prev" onclick="goToPreviousMatch()">â¬…ï¸ ä¸Šä¸€å ´</button>
                <button class="btn-finish" id="main-action-btn" onclick="manualFinishClick()">
                    <span>ä¸‹ä¸€å ´</span> â”
                </button>
            </div>
        </div>

        <div class="schedule-section">
            <div class="schedule-header">
                <span class="schedule-title">SCHEDULE</span>
                <div class="toolbar">
                    <button onclick="clearData()" style="color:var(--danger); border-color:var(--danger);">é‡ç½®</button>
                    <button onclick="addMoreMatches()">+ 5å ´</button>
                </div>
            </div>
            <div id="schedule-container" style="padding-bottom:20px;"></div>
        </div>
    </div>

    <script>
        // --- è¨­å®š ---
        // ä½¿ç”¨å›ºå®šçš„ Room IDï¼Œæ‰€æœ‰äººå…±äº«
        const GLOBAL_ROOM_ID = 'badminton_global_room_v1';
        
        const SUPABASE_URL = 'https://dgdolkbubvyggijsddtl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_-tIVFIoo0VXjtrWrKadCgw__QO8IAbW';

        // --- è®Šæ•¸ ---
        let supabase;
        let realtimeChannel = null;
        let wakeLock = null;

        // --- App State ---
        const DEFAULT_STATE = {
            players: [],
            schedule: [],
            currentIdx: 0,
            targetScore: 11, // å›ºå®š 11 åˆ†
            timestamp: 0 // ç”¨æ–¼å¼·åˆ¶åˆ·æ–°
        };
        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        let isModalOpen = false;

        // --- Wake Lock (é˜²æ­¢è¢å¹•ä¼‘çœ ) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                    });
                } catch (err) {
                    if (err.name === 'NotAllowedError') {
                        console.warn('Wake Lock request disallowed by browser/system policy.');
                    } else {
                        console.warn(`Wake Lock error: ${err.name}, ${err.message}`);
                    }
                }
            }
        }
        
        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.supabase === 'undefined') {
                alert("Supabase SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                return;
            }

            // @ts-ignore
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // Bind Keys
            document.getElementById('input-name').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addPlayer();
            });

            // é‡æ–°å–å¾— WakeLock (ç•¶åˆ‡æ› Tab å›ä¾†æ™‚)
            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    await requestWakeLock();
                }
            });

            // ç«‹å³åˆå§‹åŒ–
            initGlobalRoom();
        });

        // --- æˆ¿é–“èˆ‡é€£ç·šé‚è¼¯ (ç°¡åŒ–ç‰ˆ) ---
        async function initGlobalRoom() {
            // 1. å–å¾—åˆå§‹è³‡æ–™
            await refreshData(true); 
            
            // 2. è¨‚é–±å³æ™‚æ›´æ–°
            if(realtimeChannel) await supabase.removeChannel(realtimeChannel);
            
            realtimeChannel = supabase
                .channel('room-updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms', filter: `id=eq.${GLOBAL_ROOM_ID}` },
                    (payload) => {
                        if(payload.new && payload.new.data) {
                            state = payload.new.data;
                            syncUI();
                        }
                    }
                )
                .subscribe((status) => {
                    const dot1 = document.getElementById('connection-dot-setup');
                    const dot2 = document.getElementById('connection-dot-app');
                    if(status === 'SUBSCRIBED') {
                        dot1.classList.add('online');
                        dot2.classList.add('online');
                    } else {
                        dot1.classList.remove('online');
                        dot2.classList.remove('online');
                    }
                });
            
            // ç§»é™¤è¼‰å…¥é®ç½©
            document.getElementById('global-loader').style.display = 'none';

            // å•Ÿç”¨ Wake Lock
            requestWakeLock();
        }

        async function refreshData(isInitial = false) {
            if(!supabase) return;
            
            const btnApp = document.querySelector('#app-page .btn-icon');
            if(btnApp) btnApp.classList.add('spinning');

            const { data, error } = await supabase
                .from('rooms')
                .select('data')
                .eq('id', GLOBAL_ROOM_ID)
                .single();

            if(btnApp) setTimeout(()=>btnApp.classList.remove('spinning'), 500);

            if (error && error.code !== 'PGRST116') { 
                if(!isInitial) console.error("Sync Error", error);
                return;
            }

            if (data && data.data) {
                state = data.data;
                // ç¢ºä¿èˆŠè³‡æ–™ä¹Ÿè¢«å¼·åˆ¶æ›´æ–°ç‚º 11 åˆ†
                state.targetScore = 11;
                syncUI();
            } else if (isInitial) {
                // å¦‚æœæ˜¯æ–°æˆ¿é–“(ç¬¬ä¸€æ¬¡åŸ·è¡Œ)ï¼Œå»ºç«‹é è¨­è³‡æ–™
                await saveData(); 
                syncUI();
            }
        }

        async function saveData() {
            if(!supabase) return;
            // åŠ ä¸Šæ™‚é–“æˆ³è¨˜ç¢ºä¿æ¯æ¬¡ Update éƒ½æœ‰è®ŠåŒ–
            state.timestamp = Date.now();
            const { error } = await supabase
                .from('rooms')
                .upsert({ id: GLOBAL_ROOM_ID, data: state });
            if(error) console.error("Save error:", error);
        }

        // --- UI åŒæ­¥èˆ‡æ¸²æŸ“ ---
        function syncUI() {
            renderPlayers();
            // updateModeUI(); // å·²ç§»é™¤
            
            // æ±ºå®šé¡¯ç¤ºå“ªå€‹é é¢
            if(state.schedule.length > 0) {
                // ä¿®æ­£ Current Index é‚Šç•Œ
                if (typeof state.currentIdx !== 'number' || state.currentIdx < 0) state.currentIdx = 0;
                if (state.currentIdx >= state.schedule.length) state.currentIdx = state.schedule.length - 1;

                // ç¢ºä¿ç•¶å‰å ´æ¬¡ç‹€æ…‹æ­£ç¢º
                const m = state.schedule[state.currentIdx];
                if(m && m.status === 'pending') {
                    m.status = 'active';
                }

                updateScoreUI();
                renderSchedule();
                
                // å¦‚æœåœ¨è¨­å®šé é¢ä½†å·²ç¶“æœ‰è³½ç¨‹ï¼Œè‡ªå‹•è·³è½‰åˆ°è¨ˆåˆ†æ¿
                const setupPage = document.getElementById('setup-page');
                const appPage = document.getElementById('app-page');
                
                if (setupPage.style.display !== 'none' || (setupPage.style.display === 'none' && appPage.style.display === 'none')) {
                     showAppPage();
                }

            } else {
                showSetupPage();
            }
        }

        function showSetupPage() {
            document.getElementById('app-page').style.display = 'none';
            document.getElementById('setup-page').style.display = 'flex';
        }

        function showAppPage() {
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'flex';
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        
        function swapTeams() {
            if(state.schedule.length === 0) return;
            const m = state.schedule[state.currentIdx];
            
            // å…è¨±éš¨æ™‚äº¤æ›ï¼Œä½†å¦‚æœæ˜¯å·²çµæŸçš„å ´æ¬¡æœƒæç¤º
            if(m.status === 'finished') {
                if(!confirm("é€™å ´æ¯”è³½å·²çµæŸï¼Œç¢ºå®šè¦äº¤æ›éšŠä¼ä¸¦ä¿®æ”¹å—ï¼Ÿ")) return;
                m.status = 'active'; // æ¢å¾©æ¯”è³½
            }

            // äº¤æ›åå­—èˆ‡åˆ†æ•¸
            [m.t1, m.t2] = [m.t2, m.t1];
            [m.s1, m.s2] = [m.s2, m.s1];

            saveData();
            syncUI();
        }

        function addPlayer() {
            const input = document.getElementById('input-name');
            const name = input.value.trim();
            if(!name) return;
            if(state.players.find(p => p.name === name)) { 
                showModal("æç¤º", "åå­—é‡è¤‡å›‰", ()=>{}); return; 
            }
            state.players.push({ name, played: 0 });
            input.value = '';
            saveData();
        }

        function renderPlayers() {
            const div = document.getElementById('player-list');
            if(state.players.length === 0) {
                div.innerHTML = '<p style="color:#bbb; width:100%; text-align:center;">æš«ç„¡åå–®</p>';
                return;
            }
            div.innerHTML = state.players.map((p, i) => `
                <div class="player-tag">${p.name} <span onclick="removePlayer(${i})">Ã—</span></div>
            `).join('');
        }

        function removePlayer(idx) {
            state.players.splice(idx, 1);
            saveData();
        }

        function startSystem() {
            if(state.players.length < 4) { showModal("æç¤º","è‡³å°‘éœ€è¦ 4 ä½çƒå“¡æ‰èƒ½ç”¢ç”Ÿé›™æ‰“è³½ç¨‹",()=>{}); return; }
            state.targetScore = 11; // å¼·åˆ¶å›ºå®š 11
            
            if(state.schedule.length === 0) {
                generateMatches(5); // é è¨­ç”¢ç”Ÿ5å ´
            }
            saveData();
            // syncUI æœƒè² è²¬åˆ‡æ›é é¢
        }

        // ç”¢ç”Ÿè³½ç¨‹ (å«é€£çºŒé˜²å‘†æ©Ÿåˆ¶)
        function generateMatches(count) {
            let startId = state.schedule.length + 1;
            // å–å¾—ä¸Šä¸€å ´æ¯”è³½ï¼Œç”¨ä¾†æª¢æŸ¥é‡è¤‡çµ„åˆ
            let lastMatch = state.schedule.length > 0 ? state.schedule[state.schedule.length - 1] : null;

            for(let i=0; i<count; i++) {
                let pool = [...state.players];
                // æ’åºï¼šä¸Šå ´å°‘ -> éš¨æ©Ÿ
                pool.sort((a, b) => (a.played - b.played) || (Math.random() - 0.5));
                
                // å–å‰4äºº
                const picked = pool.slice(0, 4);
                
                // æ›´æ–°ä¸Šå ´æ¬¡æ•¸
                picked.forEach(p => {
                    const realP = state.players.find(x => x.name === p.name);
                    if(realP) realP.played++;
                });

                // --- ç”¢ç”Ÿæ‰€æœ‰å¯èƒ½çµ„åˆä¸¦æª¢æŸ¥é‡è¤‡ ---
                // 4äººæœ‰ 3 ç¨®é…å°æ–¹å¼: (0,1 vs 2,3), (0,2 vs 1,3), (0,3 vs 1,2)
                const combinations = [
                    [[picked[0], picked[1]], [picked[2], picked[3]]],
                    [[picked[0], picked[2]], [picked[1], picked[3]]],
                    [[picked[0], picked[3]], [picked[1], picked[2]]]
                ];
                
                // éš¨æ©Ÿæ‰“äº‚çµ„åˆé †åº
                combinations.sort(() => Math.random() - 0.5);

                let chosen = combinations[0]; // é è¨­é¸ç¬¬ä¸€å€‹

                // å¦‚æœæœ‰ä¸Šä¸€å ´ï¼Œå‰‡å˜—è©¦å°‹æ‰¾æ²’æœ‰é‡è¤‡æ­æª”çš„çµ„åˆ
                if (lastMatch) {
                    const isSamePair = (p1, p2) => {
                        // p1 æ˜¯æœ¬æ¬¡å€™é¸çš„çƒå“¡ç‰©ä»¶é™£åˆ—, p2 æ˜¯ä¸Šä¸€å ´çš„åå­—å­—ä¸²é™£åˆ—
                        const n1 = p1.map(x => x.name).sort().join(',');
                        const n2 = p2.sort().join(',');
                        return n1 === n2;
                    };

                    for (let combo of combinations) {
                        const teamA = combo[0];
                        const teamB = combo[1];
                        
                        // æª¢æŸ¥ AéšŠ æ˜¯å¦è·Ÿä¸Šä¸€å ´çš„ T1 æˆ– T2 é‡è¤‡
                        const conflictA = isSamePair(teamA, lastMatch.t1) || isSamePair(teamA, lastMatch.t2);
                        // æª¢æŸ¥ BéšŠ æ˜¯å¦è·Ÿä¸Šä¸€å ´çš„ T1 æˆ– T2 é‡è¤‡
                        const conflictB = isSamePair(teamB, lastMatch.t1) || isSamePair(teamB, lastMatch.t2);
                        
                        // å…©éšŠéƒ½æ²’æœ‰é‡è¤‡ï¼Œå°±æ˜¯å®Œç¾çš„çµ„åˆ
                        if (!conflictA && !conflictB) {
                            chosen = combo;
                            break;
                        }
                    }
                }

                const t1 = chosen[0].map(p => p.name);
                const t2 = chosen[1].map(p => p.name);

                const newMatch = {
                    id: startId + i,
                    t1: t1,
                    t2: t2,
                    s1: 0, s2: 0,
                    status: 'pending' 
                };
                
                state.schedule.push(newMatch);
                lastMatch = newMatch; // æ›´æ–°ä¸Šä¸€å ´ç‚ºé€™ä¸€å ´ï¼Œä¾›ä¸‹ä¸€è¼ªè¿´åœˆæª¢æŸ¥
            }
        }

        function updateScoreUI() {
            if(!state.schedule[state.currentIdx]) return;
            const m = state.schedule[state.currentIdx];
            const target = 11; // å›ºå®š 11 åˆ†

            document.getElementById('match-id').innerText = m.id;
            document.getElementById('target-score-display').innerText = target;
            
            // Text Color Logic (Winner gets Green)
            const s1Elem = document.getElementById('t1-score');
            const s2Elem = document.getElementById('t2-score');
            const fsS1Elem = document.getElementById('fs-t1-score');
            const fsS2Elem = document.getElementById('fs-t2-score');

            s1Elem.className = 'score-number' + (m.s1 > m.s2 && m.status==='finished' ? ' winner' : '');
            s2Elem.className = 'score-number' + (m.s2 > m.s1 && m.status==='finished' ? ' winner' : '');
            
            // Values
            document.getElementById('t1-names').innerHTML = `<span>${m.t1[0]}</span><span>${m.t1[1]}</span>`;
            document.getElementById('t2-names').innerHTML = `<span>${m.t2[0]}</span><span>${m.t2[1]}</span>`;
            s1Elem.innerText = m.s1;
            s2Elem.innerText = m.s2;

            // Fullscreen Sync
            document.getElementById('fs-t1-names').innerHTML = `${m.t1[0]}<br>${m.t1[1]}`;
            document.getElementById('fs-t2-names').innerHTML = `${m.t2[0]}<br>${m.t2[1]}`;
            fsS1Elem.innerText = m.s1;
            fsS2Elem.innerText = m.s2;
            
            // Fullscreen Highlight (Winner)
            fsS1Elem.className = 'fs-score' + (m.s1 > m.s2 && m.status==='finished' ? ' winner' : '');
            fsS2Elem.className = 'fs-score' + (m.s2 > m.s1 && m.status==='finished' ? ' winner' : '');

            // Main Action Button Logic
            const btn = document.getElementById('main-action-btn');
            if (m.status === 'finished') {
                btn.innerHTML = "<span>ä¿®æ”¹åˆ†æ•¸</span> (å·²çµæŸ)";
                btn.style.background = '#7f8c8d';
                btn.onclick = resumeMatch;
            } else {
                btn.innerHTML = "<span>ä¸‹ä¸€å ´</span> â”";
                btn.style.background = 'var(--primary)';
                btn.onclick = manualFinishClick;
            }
        }

        function updateScore(team, delta) {
            if(isModalOpen) return;
            const m = state.schedule[state.currentIdx];
            
            // è‹¥å·²çµæŸï¼Œéœ€å…ˆæ¢å¾©æ¯”è³½æ‰èƒ½æ”¹åˆ† (é¿å…èª¤è§¸)
            if(m.status === 'finished') {
                if(confirm("æ¯”è³½å·²çµæŸã€‚è¦æ¢å¾©æ¯”è³½ä¸¦ä¿®æ”¹åˆ†æ•¸å—ï¼Ÿ")) {
                    m.status = 'active';
                } else {
                    return;
                }
            }

            const oldS1 = m.s1;
            const oldS2 = m.s2;

            if(team === 1) m.s1 = Math.max(0, m.s1 + delta);
            else m.s2 = Math.max(0, m.s2 + delta);

            // å¦‚æœåˆ†æ•¸æ²’è®Š (ä¾‹å¦‚ 0 æ¸› 1)ï¼Œä¸è™•ç†
            if(m.s1 === oldS1 && m.s2 === oldS2) return;

            // --- ç°¡åŒ–å¾Œçš„è¦å‰‡ï¼šé”åˆ°ç›®æ¨™åˆ†æ•¸ä¸”å…©åˆ†å·®å³å‹å‡º ---
            const target = 11;
            const maxS = Math.max(m.s1, m.s2);
            const diff = Math.abs(m.s1 - m.s2);
            
            // åªè¦æ»¿è¶³ "åˆ†æ•¸åˆ°é”ç›®æ¨™" ä¸¦ä¸” "é ˜å…ˆ2åˆ†ä»¥ä¸Š" å°±çµæŸ
            const isNormalWin = (maxS >= target && diff >= 2);

            if (isNormalWin) {
                finishMatch(state.currentIdx);
            } else {
                saveData();
                syncUI(); // å› ç‚ºæ²’æœ‰ finishMatchï¼Œæ‰‹å‹• sync
            }
        }

        function manualFinishClick() {
            const m = state.schedule[state.currentIdx];
            if(m.status === 'finished') {
                // å¦‚æœå·²ç¶“çµæŸï¼ŒæŒ‰éˆ•åŠŸèƒ½æ˜¯æ‰¾ä¸‹ä¸€å ´æœªé–‹å§‹çš„
                let nextIdx = state.schedule.findIndex((match, i) => i > state.currentIdx && match.status !== 'finished');
                if(nextIdx !== -1) {
                    state.currentIdx = nextIdx;
                    state.schedule[nextIdx].status = 'active';
                    saveData();
                } else {
                    addMoreMatches(); // è‡ªå‹•åŠ å ´
                }
            } else {
                // å¼·åˆ¶çµæŸ
                if(confirm("ç¢ºå®šçµæŸæœ¬å ´æ¯”è³½ï¼Ÿ")) {
                    finishMatch(state.currentIdx);
                }
            }
        }

        function finishMatch(idx) {
            if(state.schedule[idx]) {
                state.schedule[idx].status = 'finished';
                
                // æ‰¾ä¸‹ä¸€å ´
                let nextIdx = idx + 1;
                // å¦‚æœä¸‹ä¸€å ´ä¸å­˜åœ¨ï¼Œè‡ªå‹•ç”¢ç”Ÿ
                if(nextIdx >= state.schedule.length) {
                    // é€™è£¡ä¸è‡ªå‹•ç”¢ç”Ÿï¼Œè®“ç”¨æˆ¶è‡ªå·±æŒ‰ï¼Œé¿å…ç„¡é™ç”¢ç”Ÿ
                } else {
                    state.currentIdx = nextIdx;
                    if(state.schedule[nextIdx].status === 'pending') {
                        state.schedule[nextIdx].status = 'active';
                    }
                }
                saveData();
                syncUI();
            }
        }

        function resumeMatch() {
            const m = state.schedule[state.currentIdx];
            if (m) {
                m.status = 'active';
                saveData();
                syncUI();
            }
        }

        function goToPreviousMatch() {
            if (state.currentIdx > 0) {
                state.currentIdx--;
                saveData();
                syncUI();
            }
        }

        function addMoreMatches() {
            generateMatches(5);
            // å¦‚æœç•¶å‰æ˜¯çµæŸç‹€æ…‹ï¼Œè‡ªå‹•è·³åˆ°æ–°ç”¢ç”Ÿçš„ç¬¬ä¸€å ´
            const m = state.schedule[state.currentIdx];
            if(m && m.status === 'finished') {
                const firstNew = state.schedule.findIndex(x => x.status === 'pending');
                if(firstNew !== -1) state.currentIdx = firstNew;
            }
            saveData();
            syncUI();
        }

        function clearData() {
            showModal("é‡ç½®è­¦å‘Š", "ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³½ç¨‹èˆ‡åˆ†æ•¸å—ï¼Ÿ<br>(åå–®æœƒä¿ç•™)", () => {
                // ä¿ç•™ players, é‡ç½® schedule
                state.schedule = [];
                state.currentIdx = 0;
                saveData();
                syncUI(); // é€™è£¡æœƒè‡ªå‹•åˆ‡å› setup page
            });
        }

        function renderSchedule() {
            const div = document.getElementById('schedule-container');
            if(!state.schedule.length) { div.innerHTML = ''; return; }

            div.innerHTML = state.schedule.map((m, i) => {
                const isCur = i === state.currentIdx;
                const activeClass = isCur ? 'active' : '';
                const finishedClass = m.status === 'finished' ? 'finished' : '';
                
                let scoreDisplay = `<span style="color:#666; font-size:0.8rem;">æœªé–‹å§‹</span>`;
                if(m.status === 'active') scoreDisplay = `<span style="color:var(--accent); font-weight:bold;">é€²è¡Œä¸­</span>`;
                if(m.status === 'finished') scoreDisplay = `${m.s1} : ${m.s2}`;

                // ç°¡å–®é¡¯ç¤ºå‹æ–¹åŠ ç²—
                const t1Style = (m.status==='finished' && m.s1 > m.s2) ? 'color:var(--accent); font-weight:bold;' : '';
                const t2Style = (m.status==='finished' && m.s2 > m.s1) ? 'color:var(--accent); font-weight:bold;' : '';

                return `
                    <div class="match-card ${activeClass} ${finishedClass}" onclick="jumpToMatch(${i})">
                        <div style="width:25px; color:#666; font-size:0.8rem;">#${m.id}</div>
                        <div style="flex:1; text-align:right; ${t1Style}">${m.t1[0]}<br>${m.t1[1]}</div>
                        <div style="margin:0 15px; text-align:center;">
                            <div class="score-badge">${scoreDisplay}</div>
                        </div>
                        <div style="flex:1; text-align:left; ${t2Style}">${m.t2[0]}<br>${m.t2[1]}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll to active
            setTimeout(() => {
                const el = document.querySelector('.match-card.active');
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function jumpToMatch(idx) {
            // é»æ“Šè³½ç¨‹è¡¨åˆ‡æ›å ´æ¬¡
            if(state.currentIdx === idx) return;
            state.currentIdx = idx;
            saveData();
            syncUI();
        }

        // --- å…¨è¢å¹•åŠŸèƒ½ ---
        function openFullscreen() {
            document.getElementById('fs-overlay').classList.add('show');
            const elem = document.documentElement;
            if (elem.requestFullscreen) elem.requestFullscreen().catch(()=>{});
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen(); // Safari
            
            requestWakeLock(); // å†æ¬¡ç¢ºä¿æ†äº®
        }

        function closeFullscreen() {
            document.getElementById('fs-overlay').classList.remove('show');
            if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }

        // --- Modal ---
        function showModal(title, msg, callback) {
            if(isModalOpen) return;
            isModalOpen = true;
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerHTML = msg;
            const btn = document.getElementById('modal-confirm-btn');
            
            // é‡ç½®æŒ‰éˆ•äº‹ä»¶ (cloneNode trick)
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.onclick = () => { closeModal(); callback(); };
            document.getElementById('custom-modal').classList.add('show');
        }
        function closeModal() {
            document.getElementById('custom-modal').classList.remove('show');
            setTimeout(() => { isModalOpen = false; }, 200);
        }
    </script>
</body>
</html>
