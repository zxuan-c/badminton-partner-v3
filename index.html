<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾½çƒé›™æ‰“è‡ªå‹•æ’ç¨‹èˆ‡è¨ˆåˆ†æ¿</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #27ae60;
            --danger-color: #e74c3c;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é€šç”¨æ¨£å¼ */
        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        h1, h2 { text-align: center; margin: 10px 0; font-size: 1.2rem; color: var(--primary-color); }
        
        button {
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }

        .btn-primary { background: var(--primary-color); color: white; padding: 10px 20px; width: 100%; font-size: 1rem; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-success { background: var(--accent-color); color: white; }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        /* è¨­å®šé é¢ */
        #setup-page { display: block; }
        .player-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .player-list { max-height: 300px; overflow-y: auto; margin-bottom: 20px; }
        .player-tag { 
            display: inline-block; 
            background: #e0e0e0; 
            padding: 5px 10px; 
            border-radius: 15px; 
            margin: 3px; 
            font-size: 0.9rem;
        }

        /* ä¸»æ‡‰ç”¨é é¢ (è¨ˆåˆ†æ¿ + åˆ—è¡¨) */
        #app-page { display: none; height: 100%; flex-direction: column; }

        /* è¨ˆåˆ†æ¿å€åŸŸ - æ ¸å¿ƒåŠŸèƒ½ */
        .scoreboard {
            flex: 2; /* ä½”æ“šè¼ƒå¤§æ¯”ä¾‹ */
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 15px;
            position: relative;
        }

        .match-info {
            text-align: center;
            font-size: 1rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .scores-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }

        .team {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .team-names {
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .score-display {
            font-size: 5rem;
            font-weight: 800;
            line-height: 1;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .score-controls {
            display: flex;
            gap: 15px;
        }

        .btn-score {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .vs-divider {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ccc;
            padding: 0 10px;
        }

        .match-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .match-actions button {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
        }

        /* è³½ç¨‹åˆ—è¡¨å€åŸŸ */
        .schedule-container {
            flex: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
            background: var(--card-bg);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05);
            padding: 15px;
            overflow-y: auto;
            border-top: 1px solid #eee;
        }

        .schedule-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        .schedule-item.active {
            background-color: #e8f8f5;
            border-left: 4px solid var(--accent-color);
        }
        .schedule-item.finished {
            opacity: 0.6;
            background-color: #f9f9f9;
        }
        .schedule-score {
            font-weight: bold;
            color: var(--primary-color);
        }

        /* é‡ç½®æŒ‰éˆ•å°è§’è½ */
        .reset-btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .btn-text {
            background: none;
            color: #999;
            font-size: 0.8rem;
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <div id="setup-page" class="container">
        <h1>ğŸ¸ ç¾½çƒé›™æ‰“æ’ç¨‹ç³»çµ±</h1>
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <p>è¼¸å…¥åƒåŠ äººå“¡ (5-8äººå»ºè­°)</p>
            <div class="player-input-group">
                <input type="text" id="new-player-name" placeholder="è¼¸å…¥åå­—" onkeypress="handleEnter(event)">
                <button class="btn-success" onclick="addPlayer()" style="width: 80px;">æ–°å¢</button>
            </div>
            
            <div id="player-list-display" class="player-list">
                </div>

            <div class="player-input-group">
                <button class="btn-primary" onclick="generateSchedule()">é–‹å§‹æ’ç¨‹èˆ‡æ¯”è³½</button>
            </div>
            <p style="font-size: 0.8rem; color: #888; text-align: center;">å¦‚æœå·²æœ‰ä¸Šæ¬¡ç´€éŒ„ï¼Œç³»çµ±æœƒè‡ªå‹•è¼‰å…¥</p>
            <div class="reset-btn-wrapper">
                <button class="btn-text" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡ä¾†</button>
            </div>
        </div>
    </div>

    <div id="app-page" class="container">
        
        <div class="scoreboard">
            <div class="match-info">ç¬¬ <span id="current-match-id">1</span> å ´æ¯”è³½</div>
            
            <div class="scores-container">
                <div class="team">
                    <div class="team-names" id="team-a-names">
                        é¸æ‰‹A<br>é¸æ‰‹B
                    </div>
                    <div class="score-display" id="score-a">0</div>
                    <div class="score-controls">
                        <button class="btn-score btn-danger" onclick="updateScore('A', -1)">-</button>
                        <button class="btn-score btn-success" onclick="updateScore('A', 1)">+</button>
                    </div>
                </div>

                <div class="vs-divider">VS</div>

                <div class="team">
                    <div class="team-names" id="team-b-names">
                        é¸æ‰‹C<br>é¸æ‰‹D
                    </div>
                    <div class="score-display" id="score-b">0</div>
                    <div class="score-controls">
                        <button class="btn-score btn-danger" onclick="updateScore('B', -1)">-</button>
                        <button class="btn-score btn-success" onclick="updateScore('B', 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="match-actions">
                <button class="btn-primary" onclick="finishMatch()">çµæŸæœ¬å ´ä¸¦è¨˜éŒ„</button>
            </div>
        </div>

        <div class="schedule-container">
            <h3 style="margin-top:0; font-size: 1rem;">è³½ç¨‹è¡¨</h3>
            <div id="schedule-list">
                </div>
            <div class="reset-btn-wrapper" style="margin-top: 10px;">
                 <button class="btn-text" onclick="generateMoreMatches()">+ ç”¢ç”Ÿæ›´å¤šå ´æ¬¡</button>
                 <button class="btn-text" onclick="backToSetup()" style="margin-left: 15px;">ä¿®æ”¹åå–®</button>
            </div>
        </div>
    </div>

    <script>
        // --- è³‡æ–™çµæ§‹ ---
        let state = {
            players: [], // [{name: "Alice", played: 0}, ...]
            schedule: [], // [{id: 1, t1: [p1, p2], t2: [p3, p4], s1: 0, s2: 0, status: 'pending'|'active'|'finished'}]
            currentMatchIndex: 0,
            partnerships: {}, // Key: "p1-p2" (alphabetical), Value: count
            history: [] // ç´€éŒ„èª°å“ªä¸€å ´ä¼‘æ¯ï¼Œç”¨æ–¼é¿å…é€£çºŒä¸Šå ´
        };

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            loadState();
            renderPlayerList();
            if (state.schedule.length > 0) {
                showAppPage();
                renderSchedule();
                loadCurrentMatchToScoreboard();
            }
        };

        function handleEnter(e) {
            if (e.key === 'Enter') addPlayer();
        }

        // --- è¨­å®šé é¢é‚è¼¯ ---
        function addPlayer() {
            const input = document.getElementById('new-player-name');
            const name = input.value.trim();
            if (name && !state.players.find(p => p.name === name)) {
                state.players.push({ name: name, played: 0 });
                input.value = '';
                renderPlayerList();
                saveState();
            }
        }

        function renderPlayerList() {
            const container = document.getElementById('player-list-display');
            container.innerHTML = state.players.map((p, index) => `
                <span class="player-tag">
                    ${p.name} <span style="cursor:pointer; color:red; margin-left:5px;" onclick="removePlayer(${index})">Ã—</span>
                </span>
            `).join('');
        }

        function removePlayer(index) {
            state.players.splice(index, 1);
            renderPlayerList();
            saveState();
        }

        function backToSetup() {
            if(confirm("è¿”å›ä¿®æ”¹åå–®å¯èƒ½æœƒå½±éŸ¿æ’ç¨‹é‚è¼¯ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                document.getElementById('app-page').style.display = 'none';
                document.getElementById('setup-page').style.display = 'flex';
            }
        }

        function clearAllData() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
                localStorage.removeItem('badmintonState');
                location.reload();
            }
        }

        // --- æ’ç¨‹æ¼”ç®—æ³•æ ¸å¿ƒ ---
        function generateSchedule() {
            if (state.players.length < 4) {
                alert("è‡³å°‘éœ€è¦ 4 äººæ‰èƒ½é–‹å§‹ï¼");
                return;
            }

            // åˆå§‹åŒ– partnerships ç´€éŒ„
            state.partnerships = {};
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆï¼Œå»ºç«‹åˆå§‹æ’ç¨‹
            if (state.schedule.length === 0) {
                generateBatchMatches(10); // é å…ˆç”Ÿæˆ 10 å ´
            }

            showAppPage();
            renderSchedule();
            loadCurrentMatchToScoreboard();
            saveState();
        }

        function generateMoreMatches() {
            generateBatchMatches(5);
            renderSchedule();
            saveState();
        }

        function generateBatchMatches(count) {
            let matchIdStart = state.schedule.length + 1;
            
            for (let i = 0; i < count; i++) {
                const match = createNextMatch(matchIdStart + i);
                state.schedule.push(match);
            }
        }

        function createNextMatch(id) {
            // 1. æ‰¾å‡ºæ‰€æœ‰å€™é¸äººï¼Œä¸¦åŠ å…¥éš¨æ©Ÿæ“¾å‹•ä»¥é¿å…æ­»æ¿
            // è¦å‰‡ï¼šå„ªå…ˆé¸ã€Œä¸Šå ´æ¬¡æ•¸å°‘ã€çš„äººã€‚
            // æ¬¡è¦è¦å‰‡ï¼šå„ªå…ˆé¸ã€Œä¸Šä¸€å ´ä¼‘æ¯ã€çš„äºº (ç”± played æ•¸ç›¸åŒæ™‚çš„æ’åºæ±ºå®šï¼Œæˆ–é¡å¤–æ¬Šé‡)
            
            // è¤‡è£½ä¸€ä»½çƒå“¡åå–®é€²è¡Œæ’åºè¨ˆç®—
            let candidates = [...state.players];

            // æ’åºé‚è¼¯ï¼š
            // a. ä¸Šå ´æ¬¡æ•¸ (å°‘ -> å¤š)
            // b. éš¨æ©Ÿ (ç´”éš¨æ©Ÿ) - ç”¨æˆ¶è¦æ±‚
            candidates.sort((a, b) => {
                if (a.played !== b.played) return a.played - b.played;
                return 0.5 - Math.random();
            });

            // é¸å‡ºå‰ 4 ä½
            const selectedPlayers = candidates.slice(0, 4);
            
            // æ›´æ–°ä¸Šå ´æ¬¡æ•¸
            selectedPlayers.forEach(p => {
                // åœ¨åŸå§‹ array ä¸­æ‰¾åˆ°ä¸¦æ›´æ–°
                const origin = state.players.find(op => op.name === p.name);
                origin.played++;
            });

            // 2. æ±ºå®šåˆ†çµ„ (A/B vs C/D)
            // å˜—è©¦ 3 ç¨®çµ„åˆï¼Œé¸ã€Œåˆä½œæ¬¡æ•¸ã€æœ€å°‘çš„ä¸€çµ„
            // çµ„åˆ1: (0,1) vs (2,3)
            // çµ„åˆ2: (0,2) vs (1,3)
            // çµ„åˆ3: (0,3) vs (1,2)
            
            const p = selectedPlayers;
            const combinations = [
                { t1: [p[0], p[1]], t2: [p[2], p[3]] },
                { t1: [p[0], p[2]], t2: [p[1], p[3]] },
                { t1: [p[0], p[3]], t2: [p[1], p[2]] }
            ];

            // è¨ˆç®—æ¯ç¨®çµ„åˆçš„ã€Œéå¾€æ­æª”æ¬Šé‡ã€
            combinations.forEach(combo => {
                combo.weight = getPartnershipCount(combo.t1[0], combo.t1[1]) + 
                               getPartnershipCount(combo.t2[0], combo.t2[1]);
            });

            // é¸æ¬Šé‡æœ€å°çš„ï¼Œå¦‚æœä¸€æ¨£å‰‡éš¨æ©Ÿ
            combinations.sort((a, b) => a.weight - b.weight || 0.5 - Math.random());
            const bestCombo = combinations[0];

            // æ›´æ–°æ­æª”ç´€éŒ„
            addPartnership(bestCombo.t1[0], bestCombo.t1[1]);
            addPartnership(bestCombo.t2[0], bestCombo.t2[1]);

            return {
                id: id,
                t1: bestCombo.t1.map(x => x.name),
                t2: bestCombo.t2.map(x => x.name),
                s1: 0,
                s2: 0,
                status: 'pending' // pending, active, finished
            };
        }

        function getPartnershipCount(p1, p2) {
            const key = [p1.name, p2.name].sort().join('-');
            return state.partnerships[key] || 0;
        }

        function addPartnership(p1, p2) {
            const key = [p1.name, p2.name].sort().join('-');
            state.partnerships[key] = (state.partnerships[key] || 0) + 1;
        }

        // --- é é¢åˆ‡æ›èˆ‡æ¸²æŸ“ ---
        function showAppPage() {
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'flex';
        }

        // --- è¨ˆåˆ†æ¿é‚è¼¯ ---
        function loadCurrentMatchToScoreboard() {
            // æ‰¾åˆ°ç¬¬ä¸€å€‹é‚„æ²’çµæŸçš„æ¯”è³½
            let activeIndex = state.schedule.findIndex(m => m.status !== 'finished');
            
            if (activeIndex === -1) {
                alert("æ‰€æœ‰è³½ç¨‹å·²çµæŸï¼Œè«‹ç”¢ç”Ÿæ›´å¤šå ´æ¬¡ï¼");
                generateMoreMatches(); // è‡ªå‹•ç”¢ç”Ÿ
                activeIndex = state.schedule.findIndex(m => m.status !== 'finished');
            }

            state.currentMatchIndex = activeIndex;
            const match = state.schedule[activeIndex];
            
            // æ¨™è¨˜ç‚ºé€²è¡Œä¸­
            if (match.status === 'pending') match.status = 'active';

            // UI æ›´æ–°
            document.getElementById('current-match-id').innerText = match.id;
            document.getElementById('team-a-names').innerHTML = `${match.t1[0]}<br>${match.t1[1]}`;
            document.getElementById('team-b-names').innerHTML = `${match.t2[0]}<br>${match.t2[1]}`;
            document.getElementById('score-a').innerText = match.s1;
            document.getElementById('score-b').innerText = match.s2;

            renderSchedule(); // æ›´æ–°åˆ—è¡¨é«˜äº®
            saveState();
        }

        function updateScore(team, delta) {
            const match = state.schedule[state.currentMatchIndex];
            if (!match) return;

            if (team === 'A') {
                match.s1 = Math.max(0, match.s1 + delta);
                document.getElementById('score-a').innerText = match.s1;
            } else {
                match.s2 = Math.max(0, match.s2 + delta);
                document.getElementById('score-b').innerText = match.s2;
            }
            saveState();
        }

        function finishMatch() {
            const match = state.schedule[state.currentMatchIndex];
            if (confirm(`ç¢ºå®šçµæŸé€™å ´æ¯”è³½ï¼Ÿ\næ¯”åˆ†: ${match.s1} - ${match.s2}`)) {
                match.status = 'finished';
                loadCurrentMatchToScoreboard(); // è¼‰å…¥ä¸‹ä¸€å ´
            }
        }

        function renderSchedule() {
            const list = document.getElementById('schedule-list');
            list.innerHTML = state.schedule.map((m, idx) => {
                let statusClass = '';
                if (m.status === 'active') statusClass = 'active';
                if (m.status === 'finished') statusClass = 'finished';
                
                let scoreText = (m.status === 'pending') ? 'vs' : `${m.s1} : ${m.s2}`;
                
                return `
                    <div class="schedule-item ${statusClass}" id="match-${idx}">
                        <div style="flex:1; text-align:right;">${m.t1[0]}<br>${m.t1[1]}</div>
                        <div style="padding:0 15px; text-align:center;">
                            <div style="font-size:0.8rem; color:#999;">å ´æ¬¡ ${m.id}</div>
                            <div class="schedule-score">${scoreText}</div>
                        </div>
                        <div style="flex:1; text-align:left;">${m.t2[0]}<br>${m.t2[1]}</div>
                    </div>
                `;
            }).join('');
            
            // è‡ªå‹•æ²å‹•åˆ°ç•¶å‰æ¯”è³½
            setTimeout(() => {
                const activeEl = document.querySelector('.schedule-item.active');
                if (activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // --- å„²å­˜åŠŸèƒ½ ---
        function saveState() {
            localStorage.setItem('badmintonState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('badmintonState');
            if (saved) {
                state = JSON.parse(saved);
            }
        }
    </script>
</body>
</html>
