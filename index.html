<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾½çƒé›™æ‰“æ’ç¨‹èˆ‡è¨ˆåˆ†</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --danger: #c0392b;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh; /* æ‰‹æ©Ÿç€è¦½å™¨å„ªåŒ– */
            display: flex;
            flex-direction: column;
            color: var(--text);
            overflow: hidden; /* é˜²æ­¢æ•´é«”é é¢æ»¾å‹•ï¼Œåªè®“å…§å®¹å€æ»¾å‹• */
        }

        /* --- é€šç”¨å…ƒä»¶ --- */
        h1, h2, h3 { margin: 0; text-align: center; }
        
        button {
            cursor: pointer;
            border: none;
            outline: none;
            font-family: inherit;
            transition: all 0.1s;
        }
        button:active { transform: scale(0.98); opacity: 0.9; }

        .btn-lg { width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 12px; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #666; padding: 8px 15px; border-radius: 8px; }

        input {
            width: 100%; padding: 12px; font-size: 1rem;
            border: 2px solid #ddd; border-radius: 8px;
            margin-bottom: 10px;
        }
        input:focus { border-color: var(--primary); outline: none; }

        /* --- é é¢å®¹å™¨ --- */
        .page {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            height: 100%;
        }

        /* --- è¨­å®šé é¢ (Setup Page) --- */
        #setup-page {
            display: flex; /* é è¨­é¡¯ç¤º */
            justify-content: center;
            overflow-y: auto;
        }
        
        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            min-height: 50px;
        }

        .player-tag {
            background: #e9ecef;
            color: #333;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .player-tag span { color: #999; font-size: 1.2rem; line-height: 0.8; cursor: pointer; }

        /* --- ä¸»æ‡‰ç”¨é é¢ (App Page) --- */
        #app-page {
            display: none; /* é è¨­éš±è—ï¼Œç”± JS é–‹å•Ÿ */
            gap: 15px;
            padding-bottom: 0;
        }

        /* è¨ˆåˆ†æ¿å€åŸŸ (Scoreboard) - ä½”æ¯”æœ€å¤§ */
        .scoreboard-section {
            flex: 6; /* ä½”æ“šç•«é¢ 60% é«˜åº¦ */
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .match-header {
            background: #f8f9fa;
            padding: 8px;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            border-bottom: 1px solid #eee;
        }

        .scores-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
        }

        .team-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: center;
        }

        .team-names {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            color: var(--text);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .score-number {
            font-size: 6rem; /* è¶…å¤§å­—é«” */
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
            margin: 10px 0;
            font-variant-numeric: tabular-nums;
        }

        .score-btns {
            display: flex;
            gap: 15px;
        }

        .btn-circle {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

        .vs-divider {
            font-size: 1.5rem;
            font-weight: 900;
            color: #e0e0e0;
            transform: skew(-10deg);
        }

        .action-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
        }

        /* è³½ç¨‹åˆ—è¡¨å€åŸŸ (Schedule List) */
        .schedule-section {
            flex: 4; /* ä½”æ“šç•«é¢ 40% é«˜åº¦ */
            background: var(--card);
            border-radius: 20px 20px 0 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
        }

        .match-row {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        .match-row.active { background: #e8f6f3; border-left: 4px solid var(--accent); }
        .match-row.finished { opacity: 0.5; background: #f9f9f9; }
        
        .match-id { width: 30px; color: #999; font-size: 0.8rem; }
        .match-players { flex: 1; display: flex; justify-content: space-between; text-align: center; }
        .match-vs { width: 40px; text-align: center; font-weight: bold; color: #ddd; }
        .match-score { width: 40px; text-align: center; font-weight: bold; color: var(--primary); }

        /* éš±è—å·¥å…·åˆ— */
        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .text-link { background: none; color: #888; font-size: 0.85rem; text-decoration: underline; }

    </style>
</head>
<body>

    <!-- è¨­å®šé é¢ -->
    <div id="setup-page" class="page">
        <div class="card">
            <h1>ğŸ¸ ç¾½çƒå°æˆ°ç®¡ç†</h1>
            <p style="color:#666; text-align:center; font-size:0.9rem;">è¼¸å…¥åƒåŠ äººå“¡ (5-8äºº)</p>
            
            <div style="display:flex; gap:10px;">
                <input type="text" id="input-name" placeholder="è¼¸å…¥åå­— (æŒ‰Enteræ–°å¢)" autocomplete="off">
                <button class="btn-success" onclick="addPlayer()" style="width:80px; border-radius:8px;">æ–°å¢</button>
            </div>

            <div id="player-list" class="player-list">
                <!-- JS æ¸²æŸ“åå–® -->
            </div>

            <div style="margin-top: 20px;">
                <button class="btn-lg btn-primary" onclick="startSystem()">é–‹å§‹æ’ç¨‹èˆ‡æ¯”è³½</button>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button class="text-link" onclick="clearData()">âš ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡ç½®</button>
            </div>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨é é¢ -->
    <div id="app-page" class="page">
        
        <!-- ä¸ŠåŠéƒ¨ï¼šè¨ˆåˆ†æ¿ -->
        <div class="scoreboard-section">
            <div class="match-header">
                å ´æ¬¡ <span id="match-num" style="font-weight:bold; color:var(--primary);">1</span>
                <span id="match-status-text" style="margin-left:10px; font-size:0.8rem; color:var(--accent);"></span>
            </div>

            <div class="scores-area">
                <!-- éšŠä¼ 1 -->
                <div class="team-col">
                    <div class="team-names" id="name-t1">é¸æ‰‹A<br>é¸æ‰‹B</div>
                    <div class="score-number" id="score-t1">0</div>
                    <div class="score-btns">
                        <button class="btn-circle btn-danger" onclick="addScore(1, -1)">-</button>
                        <button class="btn-circle btn-success" onclick="addScore(1, 1)">+</button>
                    </div>
                </div>

                <div class="vs-divider">VS</div>

                <!-- éšŠä¼ 2 -->
                <div class="team-col">
                    <div class="team-names" id="name-t2">é¸æ‰‹C<br>é¸æ‰‹D</div>
                    <div class="score-number" id="score-t2">0</div>
                    <div class="score-btns">
                        <button class="btn-circle btn-danger" onclick="addScore(2, -1)">-</button>
                        <button class="btn-circle btn-success" onclick="addScore(2, 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="action-area">
                <button id="finish-btn" class="btn-lg btn-primary" onclick="finishCurrentMatch()">çµæŸæœ¬å ´ä¸¦è¨˜éŒ„</button>
            </div>
        </div>

        <!-- ä¸‹åŠéƒ¨ï¼šè³½ç¨‹è¡¨ -->
        <div class="schedule-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="font-size:1rem;">ğŸ“‹ è³½ç¨‹è¡¨</h3>
                <button class="btn-outline" onclick="generateMatches(5)" style="font-size:0.8rem;">+ ç”¢ç”Ÿæ›´å¤š</button>
            </div>
            
            <div class="list-container" id="schedule-container">
                <!-- JS æ¸²æŸ“è³½ç¨‹ -->
            </div>

            <div class="toolbar">
                <button class="text-link" onclick="backToSetup()">ä¿®æ”¹åå–®</button>
                <span style="font-size:0.8rem; color:#ccc;">Auto-saved</span>
            </div>
        </div>
    </div>

    <script>
        // --- è³‡æ–™æ ¸å¿ƒ ---
        const DEFAULT_STATE = {
            players: [], // {name, playedCount}
            schedule: [], // {id, t1:[], t2:[], s1, s2, status}
            currentIdx: 0,
            partnerships: {} // "NameA-NameB": count
        };

        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadData();
                renderPlayerList();
                
                // ç¶å®š Enter éµ
                document.getElementById('input-name').addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') addPlayer();
                });

                // å¦‚æœå·²ç¶“æœ‰è³½ç¨‹ï¼Œç›´æ¥é€²å…¥ä¸»é é¢
                if (state.schedule && state.schedule.length > 0) {
                    goToAppPage();
                }
            } catch (e) {
                console.error("Init Error:", e);
                alert("åˆå§‹åŒ–éŒ¯èª¤ï¼Œç³»çµ±å°‡é‡ç½®è³‡æ–™ã€‚");
                clearData();
            }
        });

        // --- åŠŸèƒ½é‚è¼¯: è¨­å®šé é¢ ---
        function addPlayer() {
            const input = document.getElementById('input-name');
            const name = input.value.trim();
            if (!name) return;
            
            if (state.players.some(p => p.name === name)) {
                alert("åå­—é‡è¤‡å›‰ï¼");
                return;
            }

            state.players.push({ name: name, playedCount: 0 });
            input.value = '';
            saveData();
            renderPlayerList();
        }

        function removePlayer(index) {
            state.players.splice(index, 1);
            saveData();
            renderPlayerList();
        }

        function renderPlayerList() {
            const list = document.getElementById('player-list');
            if (state.players.length === 0) {
                list.innerHTML = '<div style="color:#999; width:100%; text-align:center; margin-top:10px;">å°šæœªæ–°å¢äººå“¡</div>';
                return;
            }
            list.innerHTML = state.players.map((p, i) => `
                <div class="player-tag">
                    ${p.name}
                    <span onclick="removePlayer(${i})">Ã—</span>
                </div>
            `).join('');
        }

        function startSystem() {
            if (state.players.length < 4) {
                alert("äººæ•¸ä¸è¶³ï¼Œè‡³å°‘éœ€è¦ 4 äººæ‰èƒ½é›™æ‰“ï¼");
                return;
            }
            
            if (state.schedule.length === 0) {
                state.partnerships = {}; // é‡ç½®æ­æª”ç´€éŒ„
                generateMatches(10); // é¦–æ¬¡ç”Ÿæˆ 10 å ´
            }
            
            goToAppPage();
        }

        // --- åŠŸèƒ½é‚è¼¯: æ ¸å¿ƒæ¼”ç®—æ³• ---
        function generateMatches(count) {
            const startId = state.schedule.length + 1;
            
            for (let i = 0; i < count; i++) {
                // 1. æ‰¾å‡ºå€™é¸äºº (æ‰€æœ‰çƒå“¡)
                // æ’åºæ¬Šé‡ï¼šä¸Šå ´æ¬¡æ•¸ (å°å„ªå…ˆ) > éš¨æ©Ÿæ“¾å‹•
                let pool = [...state.players];
                pool.sort((a, b) => {
                    if (a.playedCount !== b.playedCount) return a.playedCount - b.playedCount;
                    return Math.random() - 0.5;
                });

                // å–å‰ 4 ä½
                const selected = pool.slice(0, 4);
                
                // æ›´æ–°ä»–å€‘çš„ä¸Šå ´æ¬¡æ•¸ (é å…ˆå¢åŠ ï¼Œç¢ºä¿ä¸‹ä¸€å ´æ’ç¨‹æ™‚å·²è€ƒæ…®)
                selected.forEach(p => {
                    const original = state.players.find(x => x.name === p.name);
                    if(original) original.playedCount++;
                });

                // 2. æ’åˆ—çµ„åˆ (æ‰¾å‡ºæ­æª”é‡è¤‡æœ€å°‘çš„çµ„åˆ)
                // çµ„åˆA: (0,1) vs (2,3)
                // çµ„åˆB: (0,2) vs (1,3)
                // çµ„åˆC: (0,3) vs (1,2)
                const combos = [
                    { t1: [selected[0], selected[1]], t2: [selected[2], selected[3]] },
                    { t1: [selected[0], selected[2]], t2: [selected[1], selected[3]] },
                    { t1: [selected[0], selected[3]], t2: [selected[1], selected[2]] }
                ];

                // è¨ˆç®—æ¬Šé‡ (éå¾€æ­æª”æ¬¡æ•¸ç¸½å’Œ)
                combos.forEach(c => {
                    const w1 = getPartnership(c.t1[0].name, c.t1[1].name);
                    const w2 = getPartnership(c.t2[0].name, c.t2[1].name);
                    c.weight = w1 + w2;
                });

                // é¸æ¬Šé‡æœ€å°çš„ï¼Œè‹¥ä¸€æ¨£å‰‡éš¨æ©Ÿ
                combos.sort((a, b) => a.weight - b.weight || (Math.random() - 0.5));
                const best = combos[0];

                // è¨˜éŒ„æ­æª”é—œä¿‚
                addPartnership(best.t1[0].name, best.t1[1].name);
                addPartnership(best.t2[0].name, best.t2[1].name);

                // æ¨å…¥è³½ç¨‹
                state.schedule.push({
                    id: startId + i,
                    t1: [best.t1[0].name, best.t1[1].name],
                    t2: [best.t2[0].name, best.t2[1].name],
                    s1: 0,
                    s2: 0,
                    status: 'pending'
                });
            }
            saveData();
            renderScheduleList();
            updateScoreBoardUI();
        }

        function getPartnership(n1, n2) {
            const key = [n1, n2].sort().join('|');
            return state.partnerships[key] || 0;
        }

        function addPartnership(n1, n2) {
            const key = [n1, n2].sort().join('|');
            state.partnerships[key] = (state.partnerships[key] || 0) + 1;
        }

        // --- åŠŸèƒ½é‚è¼¯: ä¸»é é¢ ---
        function goToAppPage() {
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'flex';
            
            // æ‰¾å‡ºç¬¬ä¸€å ´æœªå®Œæˆçš„
            let nextIdx = state.schedule.findIndex(m => m.status !== 'finished');
            if (nextIdx === -1) {
                // å‡å¦‚å…¨éƒ¨éƒ½æ‰“å®Œäº†ï¼Œè‡ªå‹•æ–°å¢
                generateMatches(5);
                nextIdx = state.schedule.findIndex(m => m.status !== 'finished');
            }
            state.currentIdx = nextIdx;
            
            // å¦‚æœç‹€æ…‹æ˜¯ pendingï¼Œæ”¹æˆ active
            if (state.schedule[state.currentIdx].status === 'pending') {
                state.schedule[state.currentIdx].status = 'active';
            }

            updateScoreBoardUI();
            renderScheduleList();
        }

        function updateScoreBoardUI() {
            const match = state.schedule[state.currentIdx];
            if (!match) return;

            document.getElementById('match-num').textContent = match.id;
            document.getElementById('name-t1').innerHTML = `${match.t1[0]}<br>${match.t1[1]}`;
            document.getElementById('name-t2').innerHTML = `${match.t2[0]}<br>${match.t2[1]}`;
            document.getElementById('score-t1').textContent = match.s1;
            document.getElementById('score-t2').textContent = match.s2;
            
            // é«˜äº®ç•¶å‰åˆ—è¡¨
            renderScheduleList();
        }

        function addScore(team, delta) {
            const match = state.schedule[state.currentIdx];
            if (!match || match.status === 'finished') return;

            if (team === 1) {
                match.s1 = Math.max(0, match.s1 + delta);
                document.getElementById('score-t1').textContent = match.s1;
            } else {
                match.s2 = Math.max(0, match.s2 + delta);
                document.getElementById('score-t2').textContent = match.s2;
            }
            saveData();
            renderScheduleList(); // åŒæ­¥æ›´æ–°åˆ—è¡¨ä¸Šçš„æ¯”åˆ†
        }

        function finishCurrentMatch() {
            const match = state.schedule[state.currentIdx];
            if(confirm(`ç¢ºèªçµæŸæœ¬å ´æ¯”è³½ï¼Ÿ\næœ€çµ‚æ¯”åˆ† ${match.s1} : ${match.s2}`)) {
                match.status = 'finished';
                saveData();
                goToAppPage(); // æœƒè‡ªå‹•è·³åˆ°ä¸‹ä¸€å ´
            }
        }

        function renderScheduleList() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = state.schedule.map((m, i) => {
                const isActive = i === state.currentIdx;
                let rowClass = 'match-row';
                if (m.status === 'active') rowClass += ' active';
                if (m.status === 'finished') rowClass += ' finished';

                const scoreDisplay = m.status === 'pending' ? 'vs' : `${m.s1}:${m.s2}`;
                const scoreColor = m.status === 'pending' ? '#ddd' : 'var(--primary)';

                return `
                    <div class="${rowClass}" id="match-row-${i}">
                        <div class="match-id">${m.id}</div>
                        <div class="match-players">
                            <div style="flex:1; text-align:right;">${m.t1[0]}<br>${m.t1[1]}</div>
                            <div class="match-vs" style="color:${scoreColor}">${scoreDisplay}</div>
                            <div style="flex:1; text-align:left;">${m.t2[0]}<br>${m.t2[1]}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // è‡ªå‹•æ²å‹•
            setTimeout(() => {
                const activeEl = document.querySelector('.match-row.active');
                if(activeEl) activeEl.scrollIntoView({behavior: 'smooth', block: 'center'});
            }, 100);
        }

        function backToSetup() {
            if(confirm("è¿”å›ä¿®æ”¹åå–®å¯èƒ½æœƒå½±éŸ¿å¾ŒçºŒæ’ç¨‹ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                document.getElementById('app-page').style.display = 'none';
                document.getElementById('setup-page').style.display = 'flex';
            }
        }

        // --- å„²å­˜ç³»çµ± ---
        function saveData() {
            try {
                localStorage.setItem('badminton_sys_v2', JSON.stringify(state));
            } catch(e) { console.error("Save failed", e); }
        }

        function loadData() {
            const raw = localStorage.getItem('badminton_sys_v2');
            if (raw) {
                try {
                    const loaded = JSON.parse(raw);
                    // ç°¡å–®çš„åˆä½µæª¢æŸ¥ï¼Œç¢ºä¿æ ¼å¼æ­£ç¢º
                    if (loaded.players && loaded.schedule) {
                        state = loaded;
                    }
                } catch(e) {
                    console.error("Data corrupted");
                }
            }
        }

        function clearData() {
            if(confirm("é€™æœƒåˆªé™¤æ‰€æœ‰åå–®å’Œå°æˆ°ç´€éŒ„ï¼Œç¢ºå®šé‡ä¾†ï¼Ÿ")) {
                localStorage.removeItem('badminton_sys_v2');
                location.reload();
            }
        }

    </script>
</body>
</html>
