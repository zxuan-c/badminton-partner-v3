<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / Mobile Web App Ë®≠ÂÆö -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <title>ÁæΩÁêÉÊéíÁ®ã (SupabaseÁâà)</title>
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1165/1165187.png">

    <!-- Supabase SDK (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- Âü∫Á§éË®≠ÂÆö --- */
        :root {
            --primary: #2c3e50;
            --accent: #27ae60; /* Á∂†Ëâ≤ */
            --danger: #e74c3c; /* Á¥ÖËâ≤ */
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #333;
            --modal-bg: rgba(0, 0, 0, 0.6);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            color: var(--text);
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        button {
            cursor: pointer;
            border: none;
            outline: none;
            font-family: inherit;
            font-weight: bold;
            transition: transform 0.1s, opacity 0.1s;
            user-select: none;
        }
        button:active { transform: scale(0.96); opacity: 0.9; }

        /* --- ÂÖ®Ëû¢ÂπïË®àÂàÜÊ®°Âºè --- */
        #fs-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; 
            height: 100svh; 
            background: #000;
            z-index: 2000;
            flex-direction: column;
            color: white;
            padding-top: max(env(safe-area-inset-top), 20px);
            padding-bottom: env(safe-area-inset-bottom);
        }
        #fs-overlay.show { display: flex; }

        .fs-close-btn {
            position: absolute;
            top: max(env(safe-area-inset-top), 20px); 
            right: 20px;
            width: 40px; height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.8);
            font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            z-index: 2001;
            cursor: pointer;
        }

        .fs-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 10px;
            margin-top: 30px; 
        }

        .fs-team {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .fs-names {
            font-size: clamp(1.5rem, 4vw, 3rem);
            color: #ccc;
            text-align: center;
            margin-bottom: 2vh;
            font-weight: bold;
            line-height: 1.3;
        }

        .fs-score {
            font-size: 30vw;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
            margin-bottom: 3vh;
            font-variant-numeric: tabular-nums;
            cursor: pointer;
        }

        .fs-controls {
            display: flex;
            gap: 20px;
        }

        .fs-btn {
            width: 12vw; height: 12vw;
            max-width: 80px; max-height: 80px;
            min-width: 50px; min-height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            color: white;
        }
        .fs-btn.minus { background: var(--danger); opacity: 0.8; }
        .fs-btn.plus { background: var(--accent); }

        .fs-divider {
            width: 1px;
            height: 60%;
            background: #333;
            margin: 0 5px;
        }

        /* --- Ëá™Ë®ÇÂΩàË∑≥Ë¶ñÁ™ó (Modal) --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
        
        .modal-card {
            background: white;
            width: 85%;
            max-width: 320px;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-title { font-size: 1.4rem; font-weight: 900; color: var(--primary); margin-bottom: 10px; }
        .modal-msg { font-size: 1rem; color: #555; margin-bottom: 20px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 1rem; }
        .btn-cancel { background: #eee; color: #666; }
        .btn-confirm { background: var(--accent); color: white; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- È†ÅÈù¢ÂÆπÂô® --- */
        .page {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 100%;
        }

        #room-page {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #setup-page { display: none; overflow-y: auto; }
        
        .setup-card {
            background: var(--card);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
            margin-top: 20px;
        }

        input {
            width: 100%; padding: 12px; font-size: 1rem;
            border: 2px solid #ddd; border-radius: 8px;
            margin-bottom: 10px;
            -webkit-appearance: none;
        }
        
        .player-tag {
            display: inline-flex;
            align-items: center;
            background: #e9ecef;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 1rem;
        }
        .player-tag span { color: #999; margin-left: 8px; cursor: pointer; font-size: 1.2rem; }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .mode-label {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .mode-label.selected {
            background: #e8f5e9;
            border-color: var(--accent);
            color: var(--accent);
            font-weight: bold;
        }

        #app-page {
            display: none;
            flex-direction: column;
            padding: 0;
            max-width: 100%;
            height: 100%;
            background: #222;
        }

        .scoreboard-section {
            flex: 1;
            background: var(--card);
            border-radius: 0 0 30px 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            padding: 15px;
            position: relative;
            z-index: 10;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            overflow-y: auto;
        }

        .match-info-bar {
            text-align: center;
            color: #888;
            font-size: 1rem;
            border-bottom: 1px solid #f5f5f5;
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .target-score-badge {
            background: #eee;
            color: #666;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .room-badge {
            background: #e3f2fd;
            color: #1565c0;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .scores-display {
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex: 1;
            margin-bottom: 10px;
        }

        .team-block {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .team-names {
            font-size: 1.5rem; 
            font-weight: 900;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            line-height: 1.2;
            min-height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-direction: column;
            word-break: break-word;
            padding: 0 5px;
        }

        .score-number {
            font-size: clamp(4rem, 15vh, 8rem);
            line-height: 1;
            font-weight: 800;
            color: var(--primary);
            margin: 5px 0 15px 0;
            font-variant-numeric: tabular-nums;
            cursor: pointer;
        }

        .score-controls {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .btn-control {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            color: white;
        }
        .btn-minus { background-color: var(--danger); }
        .btn-plus { background-color: var(--accent); }

        .vs-text {
            font-size: 1.5rem;
            color: #e0e0e0;
            font-weight: 900;
            margin: 0 10px;
            font-style: italic;
            align-self: center;
        }

        .next-match-area {
            margin-top: auto;
            padding-top: 15px;
        }
        .btn-finish {
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.4);
        }

        .schedule-section {
            height: 30vh;
            min-height: 180px;
            flex: none;
            background: #f0f2f5;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 5px;
            color: #666;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .schedule-list { flex: 1; }

        .match-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            font-size: 1rem;
            border-left: 5px solid transparent;
        }
        .match-card.active { border-left-color: var(--accent); background: #fff; }
        .match-card.finished { opacity: 0.6; background: #e9ecef; color: #888; }

        .score-badge {
            background: #eee;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #555;
            min-width: 60px;
            text-align: center;
            font-size: 0.9rem;
        }
        .active .score-badge { background: var(--accent); color: white; }
        .btn-green { background: var(--accent); color: white; border-radius: 8px; padding: 10px 20px; }
        .btn-outline { border: 1px solid #aaa; background: white; color: #555; border-radius: 6px; padding: 5px 12px; font-size: 0.85rem; }

        .loading { color: #999; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <!-- ÂÖ®Ëû¢ÂπïË®àÂàÜÊ®°Âºè -->
    <div id="fs-overlay">
        <button class="fs-close-btn" onclick="closeFullscreen()">‚úï</button>
        <div class="fs-container">
            <div class="fs-team">
                <div class="fs-names" id="fs-t1-names"></div>
                <div class="fs-score" id="fs-t1-score" onclick="updateScore(1, 1)">0</div>
                <div class="fs-controls">
                    <button class="fs-btn minus" onclick="updateScore(1, -1)">-</button>
                    <button class="fs-btn plus" onclick="updateScore(1, 1)">+</button>
                </div>
            </div>
            
            <div class="fs-divider"></div>

            <div class="fs-team">
                <div class="fs-names" id="fs-t2-names"></div>
                <div class="fs-score" id="fs-t2-score" onclick="updateScore(2, 1)">0</div>
                <div class="fs-controls">
                    <button class="fs-btn minus" onclick="updateScore(2, -1)">-</button>
                    <button class="fs-btn plus" onclick="updateScore(2, 1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂΩàË∑≥Ë¶ñÁ™ó -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-msg" id="modal-msg"></div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="modal-btn btn-confirm" id="modal-confirm-btn">Á¢∫ÂÆö</button>
            </div>
        </div>
    </div>

    <!-- 0. ÊàøÈñìÈÅ∏ÊìáÈ†ÅÈù¢ -->
    <div id="room-page" class="page">
        <div class="setup-card" style="text-align:center;">
            <h1 style="color:var(--primary); margin-bottom:10px;">üè∏ ÈÄ£Á∑öÁæΩÁêÉÊéíÁ®ã</h1>
            <p style="color:#666; margin-bottom:20px;">Ë´ãËº∏ÂÖ•ÁêÉÈöä‰ª£Á¢º (Room ID)<br>ËÆìÂ§ßÂÆ∂ÈÄ≤ÂÖ•Âêå‰∏ÄÂÄãÊàøÈñì</p>
            
            <input type="text" id="room-id-input" placeholder="‰æãÂ¶Ç: team_friday" style="text-align:center; font-size:1.2rem; font-weight:bold;">
            <button class="btn-green" style="width:100%; padding:15px; font-size:1.1rem;" onclick="joinRoom()">ÈÄ≤ÂÖ•ÊàøÈñì</button>
            <div id="loading-text" class="loading" style="display:none;">Ê≠£Âú®ÈÄ£Á∑ö Supabase...</div>
        </div>
    </div>

    <!-- 1. Ë®≠ÂÆöÈ†ÅÈù¢ -->
    <div id="setup-page" class="page">
        <div class="setup-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color: var(--primary); margin:0;">Ë®≠ÂÆöËàáÂêçÂñÆ</h2>
                <span id="room-display-setup" class="room-badge"></span>
            </div>
            
            <div style="text-align:center; margin-bottom:5px; color:#666; font-size:0.9rem;">ÈÅ∏ÊìáË≥ΩÂà∂</div>
            <div class="mode-selector">
                <label class="mode-label selected" onclick="selectMode(21, this)">
                    21ÂàÜÂà∂
                    <input type="radio" name="mode" value="21" checked>
                </label>
                <label class="mode-label" onclick="selectMode(11, this)">
                    11ÂàÜÂà∂
                    <input type="radio" name="mode" value="11">
                </label>
            </div>

            <p style="color:#666; font-size:0.9rem; margin-top:10px;">ÂêçÂñÆ (Êõ¥ÂãïÊúÉÂç≥ÊôÇÂêåÊ≠•)</p>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="input-name" placeholder="Ëº∏ÂÖ•ÂêçÂ≠ó (ÊåâEnter)" autocomplete="off">
                <button class="btn-green" onclick="addPlayer()">Êñ∞Â¢û</button>
            </div>

            <div id="player-list" style="margin-bottom:20px; min-height: 50px;"></div>

            <button class="btn-green" style="width:100%; padding:15px; font-size:1.1rem; margin-bottom:15px;" onclick="startSystem()">
                ÈñãÂßã / ÁπºÁ∫åÊØîË≥Ω
            </button>
            
            <div style="text-align:center;">
                <button class="btn-outline" onclick="exitRoom()">Èõ¢ÈñãÊàøÈñì</button>
            </div>
        </div>
    </div>

    <!-- 2. ‰∏ªÊáâÁî®È†ÅÈù¢ -->
    <div id="app-page">
        <div class="scoreboard-section">
            <div class="match-info-bar">
                Á¨¨ <span id="match-id" style="font-weight:bold; color:var(--primary);">1</span> Â†¥
                <span id="target-score-display" class="target-score-badge">21ÂàÜÂà∂</span>
                <span id="room-display-app" class="room-badge" style="margin-left:5px;"></span>
                <button class="btn-outline" style="margin-left:auto; padding:5px 10px;" onclick="openFullscreen()">‚õ∂ ÂÖ®Ëû¢Âπï</button>
            </div>

            <div class="scores-display">
                <div class="team-block">
                    <div class="team-names" id="t1-names"></div>
                    <div class="score-number" id="t1-score" onclick="updateScore(1, 1)">0</div>
                    <div class="score-controls">
                        <button class="btn-control btn-minus" onclick="updateScore(1, -1)">-</button>
                        <button class="btn-control btn-plus" onclick="updateScore(1, 1)">+</button>
                    </div>
                </div>
                <div class="vs-text">VS</div>
                <div class="team-block">
                    <div class="team-names" id="t2-names"></div>
                    <div class="score-number" id="t2-score" onclick="updateScore(2, 1)">0</div>
                    <div class="score-controls">
                        <button class="btn-control btn-minus" onclick="updateScore(2, -1)">-</button>
                        <button class="btn-control btn-plus" onclick="updateScore(2, 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="next-match-area">
                <button class="btn-finish" onclick="manualFinishClick()">ÁµêÊùüÊú¨Â†¥ (‰∏ã‰∏ÄÂ†¥) ‚ûî</button>
            </div>
        </div>

        <div class="schedule-section">
            <div class="schedule-header">
                <span>Ë≥ΩÁ®ãË°®</span>
                <div>
                    <button class="btn-outline" onclick="clearData()" style="color:var(--danger); border-color:var(--danger);">ÂÖ®ÈÉ®ÈáçÁΩÆ</button>
                    <button class="btn-outline" onclick="addMoreMatches()">+ Áî¢Áîü</button>
                </div>
            </div>
            <div class="schedule-list" id="schedule-container"></div>
        </div>
    </div>

    <script>
        // --- Ë®≠ÂÆö (Ë´ãÂ°´ÂÖ•ÊÇ®ÁöÑ Supabase Ë≥áË®ä) ---
        const SUPABASE_URL = 'https://dgdolkbubvyggijsddtl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_-tIVFIoo0VXjtrWrKadCgw__QO8IAbW';

        // --- Init ---
        let supabase;
        let realtimeChannel = null;
        let currentRoomId = "";

        // --- App State ---
        const DEFAULT_STATE = {
            players: [],
            schedule: [],
            currentIdx: 0,
            partnerships: {},
            targetScore: 21
        };
        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        let tempTargetScore = 21;
        let isModalOpen = false;

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient === 'undefined') {
                console.error("Supabase SDK not loaded");
                alert("Supabase SDK ËºâÂÖ•Â§±Êïó");
                return;
            }

            try {
                // @ts-ignore
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } catch (e) { console.error(e); }

            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if(roomParam) {
                document.getElementById('room-id-input').value = roomParam;
                joinRoom();
            }

            document.getElementById('input-name').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addPlayer();
            });
            document.getElementById('room-id-input').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') joinRoom();
            });
        });

        // --- ÊàøÈñìËàáÈÄ£Á∑öÈÇèËºØ ---
        async function joinRoom() {
            const input = document.getElementById('room-id-input');
            const roomId = input.value.trim();
            if(!roomId) { showModal("ÊèêÁ§∫", "Ë´ãËº∏ÂÖ•ÊàøÈñì‰ª£Á¢º", ()=>{}); return; }

            currentRoomId = roomId;
            document.getElementById('loading-text').style.display = 'block';

            // 1. ËÆÄÂèñÂàùÂßãË≥áÊñô
            const { data, error } = await supabase
                .from('rooms')
                .select('data')
                .eq('id', roomId)
                .single();

            if (error && error.code !== 'PGRST116') { 
                console.error("Fetch error:", error);
            }

            if (data && data.data) {
                state = data.data;
            } else {
                await saveData(); 
            }
            
            // 2. Ë®ÇÈñ±Âç≥ÊôÇÊõ¥Êñ∞
            if(realtimeChannel) await supabase.removeChannel(realtimeChannel);
            
            realtimeChannel = supabase
                .channel('room-updates')
                .on(
                    'postgres_changes',
                    {
                        event: '*', 
                        schema: 'public',
                        table: 'rooms',
                        filter: `id=eq.${roomId}`
                    },
                    (payload) => {
                        if(payload.new && payload.new.data) {
                            state = payload.new.data;
                            syncUI();
                        }
                    }
                )
                .subscribe();

            document.getElementById('loading-text').style.display = 'none';
            syncUI();
            
            if(state.schedule.length > 0) {
                showAppPage();
            } else {
                showSetupPage();
            }

            document.getElementById('room-display-setup').innerText = roomId;
            document.getElementById('room-display-app').innerText = roomId;
            
            try {
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + roomId;
                window.history.replaceState({path:newUrl},'',newUrl);
            } catch(e){}
        }

        async function saveData() {
            if(!currentRoomId || !supabase) return;
            const { error } = await supabase
                .from('rooms')
                .upsert({ id: currentRoomId, data: state });
            if(error) console.error("Save error:", error);
        }

        function exitRoom() {
            if(realtimeChannel) supabase.removeChannel(realtimeChannel);
            realtimeChannel = null;
            state = JSON.parse(JSON.stringify(DEFAULT_STATE));
            currentRoomId = "";
            document.getElementById('app-page').style.display = 'none';
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('room-page').style.display = 'flex';
        }

        // --- ÂêåÊ≠• UI (‰øÆÊ≠£Áâà) ---
        function syncUI() {
            renderPlayers();
            updateModeUI();
            
            if(state.schedule.length > 0) {
                // Ëá™ÂãïÂ∞ãÊâæÁ¨¨‰∏ÄÂÄãÂ∞öÊú™ÁµêÊùüÁöÑÊØîË≥Ω
                let activeIdx = state.schedule.findIndex(m => m.status !== 'finished');
                
                // Â¶ÇÊûúÂÖ®ÈÉ®ÈÉΩÊâìÂÆå‰∫ÜÔºåÂÅúÁïôÂú®ÊúÄÂæå‰∏ÄÂ†¥
                if (activeIdx === -1) {
                    activeIdx = state.schedule.length - 1;
                }
                
                // Êõ¥Êñ∞Áï∂ÂâçÁ¥¢Âºï (ÈÄôÊòØÊúÄÈáçË¶ÅÁöÑ‰øÆÊ≠£)
                state.currentIdx = activeIdx;
                
                // Ê®ôË®òÁÇ∫ÈÄ≤Ë°å‰∏≠ (Â¶ÇÊûúÂ∞öÊú™Ê®ôË®ò)
                if (state.schedule[activeIdx] && state.schedule[activeIdx].status === 'pending') {
                    // Ê≥®ÊÑèÔºöÈÄôË£°Âè™Êõ¥Êñ∞Êú¨Âú∞È°ØÁ§∫ÁãÄÊÖãÔºå‰∏çËá™ÂãïÂØ´ÂõûË≥áÊñôÂ∫´ÔºåÈÅøÂÖçËÆÄÂØ´Ëø¥Âúà
                    // ÂØ¶ÈöõÁãÄÊÖãÊîπËÆäÊúÉÁî±Êìç‰ΩúËÄÖËß∏Áôº
                }

                updateScoreUI();
                renderSchedule();
                
                // Á¢∫‰øùÂú® App È†ÅÈù¢
                const isAppVisible = document.getElementById('app-page').style.display === 'flex';
                if(!isAppVisible && state.schedule.length > 0) {
                    showAppPage();
                }
            }
        }

        // --- È†ÅÈù¢ÂàáÊèõ ---
        function showSetupPage() {
            document.getElementById('room-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'none';
            document.getElementById('setup-page').style.display = 'flex';
        }

        function showAppPage() {
            document.getElementById('room-page').style.display = 'none';
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'flex';
            
            // ÊâæÂá∫Ê≠£Âú®ÈÄ≤Ë°åÁöÑÂ†¥Ê¨°
            let idx = state.schedule.findIndex(m => m.status !== 'finished');
            if(idx === -1 && state.schedule.length > 0) idx = state.schedule.length - 1;
            else if(idx === -1) { showSetupPage(); return; }
            
            state.currentIdx = idx;
            // Ëß∏ÁôºÁãÄÊÖãÊõ¥Êñ∞
            if(state.schedule[idx] && state.schedule[idx].status === 'pending') {
                state.schedule[idx].status = 'active';
                saveData();
            }
            updateScoreUI();
            renderSchedule();
        }

        // --- Ê•≠ÂãôÈÇèËºØ ---
        function selectMode(score, element) {
            tempTargetScore = score;
            document.querySelectorAll('.mode-label').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        function updateModeUI() {
            const currentScore = state.targetScore || 21;
            const radios = document.getElementsByName('mode');
            radios.forEach(r => {
                if(parseInt(r.value) === currentScore) {
                    r.checked = true;
                    r.parentElement.classList.add('selected');
                } else {
                    r.parentElement.classList.remove('selected');
                }
            });
        }

        function addPlayer() {
            const input = document.getElementById('input-name');
            const name = input.value.trim();
            if(!name) return;
            if(state.players.find(p => p.name === name)) { 
                showModal("ÊèêÁ§∫", "ÂêçÂ≠óÈáçË§áÂõâ", ()=>{}); 
                return; 
            }
            state.players.push({ name, played: 0 });
            input.value = '';
            saveData();
        }

        function renderPlayers() {
            const div = document.getElementById('player-list');
            if(state.players.length === 0) {
                div.innerHTML = '<p style="color:#999; padding:10px;">ÂêçÂñÆÁ©∫ÁôΩ</p>';
                return;
            }
            div.innerHTML = state.players.map((p, i) => `
                <div class="player-tag">${p.name} <span onclick="removePlayer(${i})">√ó</span></div>
            `).join('');
        }

        function removePlayer(idx) {
            state.players.splice(idx, 1);
            saveData();
        }

        function startSystem() {
            if(state.players.length < 4) { showModal("ÊèêÁ§∫","Ëá≥Â∞ëÈúÄË¶Å4‰∫∫",()=>{}); return; }
            state.targetScore = tempTargetScore;
            
            if(state.schedule.length === 0) {
                state.partnerships = {};
                generateMatches(10);
            } else {
                saveData();
                showAppPage();
            }
        }

        function generateMatches(count) {
            const startId = state.schedule.length + 1;
            for(let i=0; i<count; i++) {
                let pool = [...state.players];
                pool.sort((a, b) => (a.played - b.played) || (Math.random() - 0.5));
                const picked = pool.slice(0, 4);
                
                picked.forEach(p => {
                    const realP = state.players.find(x => x.name === p.name);
                    if(realP) realP.played++;
                });

                const t1 = [picked[0], picked[1]];
                const t2 = [picked[2], picked[3]];

                state.schedule.push({
                    id: startId + i,
                    t1: t1.map(p=>p.name),
                    t2: t2.map(p=>p.name),
                    s1: 0, s2: 0, status: 'pending'
                });
            }
            saveData();
        }

        function updateScoreUI() {
            if(!state.schedule[state.currentIdx]) return;
            const m = state.schedule[state.currentIdx];
            const target = state.targetScore || 21;

            document.getElementById('match-id').innerText = m.id;
            document.getElementById('target-score-display').innerText = `${target}ÂàÜÂà∂`;
            
            // ‰∏ÄËà¨‰ªãÈù¢
            document.getElementById('t1-names').innerText = `${m.t1[0]} / ${m.t1[1]}`;
            document.getElementById('t2-names').innerText = `${m.t2[0]} / ${m.t2[1]}`;
            document.getElementById('t1-score').innerText = m.s1;
            document.getElementById('t2-score').innerText = m.s2;

            // ÂÖ®Ëû¢Âπï‰ªãÈù¢ÂêåÊ≠•Êõ¥Êñ∞
            document.getElementById('fs-t1-names').innerText = `${m.t1[0]} / ${m.t1[1]}`;
            document.getElementById('fs-t2-names').innerText = `${m.t2[0]} / ${m.t2[1]}`;
            document.getElementById('fs-t1-score').innerText = m.s1;
            document.getElementById('fs-t2-score').innerText = m.s2;
        }

        function updateScore(team, delta) {
            if(isModalOpen) return;
            const m = state.schedule[state.currentIdx];
            if(!m || m.status === 'finished') return;

            if(team === 1) m.s1 = Math.max(0, m.s1 + delta);
            else m.s2 = Math.max(0, m.s2 + delta);

            const target = state.targetScore || 21;
            const maxS = Math.max(m.s1, m.s2);
            const diff = Math.abs(m.s1 - m.s2);

            if(maxS >= target && diff >= 2) {
                finishMatch(state.currentIdx);
            } else {
                saveData();
            }
        }

        function manualFinishClick() {
            const m = state.schedule[state.currentIdx];
            if(!m || m.status === 'finished') return;
            finishMatch(state.currentIdx);
        }

        function finishMatch(idx) {
            if(state.schedule[idx]) {
                state.schedule[idx].status = 'finished';
                
                // Êú¨Âú∞È†êÂÖàË®àÁÆó‰∏ã‰∏ÄÂ†¥ÔºåÁ¢∫‰øùUIÂç≥ÊôÇÂèçÊáâ
                let nextIdx = state.schedule.findIndex(m => m.status !== 'finished' && m !== state.schedule[idx]);
                // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåÂèØËÉΩÂ∞±ÊòØÂâõÁµêÊùüÁöÑ‰∏ã‰∏ÄÂ†¥
                if(nextIdx === -1 && idx < state.schedule.length - 1) {
                    nextIdx = idx + 1;
                }
                
                if (nextIdx !== -1) {
                    state.currentIdx = nextIdx;
                    if(state.schedule[nextIdx].status === 'pending') {
                        state.schedule[nextIdx].status = 'active';
                    }
                }
                
                saveData();
                syncUI(); // Á´ãÂç≥Êõ¥Êñ∞ UI
            }
        }

        function addMoreMatches() {
            generateMatches(5);
        }

        function clearData() {
            showModal("Ë≠¶Âëä", "ÈÄôÊúÉÊ∏ÖÈô§Ê≠§ÊàøÈñìÊâÄÊúâË≥áÊñôÔºåÁ¢∫ÂÆöÔºü", () => {
                state = JSON.parse(JSON.stringify(DEFAULT_STATE));
                state.targetScore = tempTargetScore;
                saveData();
                showSetupPage();
            });
        }

        function renderSchedule() {
            const div = document.getElementById('schedule-container');
            div.innerHTML = state.schedule.map((m, i) => {
                const isCur = i === state.currentIdx;
                const activeClass = isCur ? 'active' : '';
                const finishedClass = m.status === 'finished' ? 'finished' : '';
                const scoreText = m.status === 'pending' ? 'vs' : `${m.s1}:${m.s2}`;
                
                return `
                    <div class="match-card ${activeClass} ${finishedClass}" id="match-${i}">
                        <div style="width:30px; color:#999; font-size:0.9rem;">${m.id}</div>
                        <div style="flex:1; text-align:right; font-weight:500;">${m.t1[0]} / ${m.t1[1]}</div>
                        <div style="margin:0 12px;" class="score-badge">${scoreText}</div>
                        <div style="flex:1; text-align:left; font-weight:500;">${m.t2[0]} / ${m.t2[1]}</div>
                    </div>
                `;
            }).join('');
            
            setTimeout(() => {
                const el = document.querySelector('.match-card.active');
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // --- ÂÖ®Ëû¢ÂπïÂäüËÉΩ ---
        function openFullscreen() {
            document.getElementById('fs-overlay').classList.add('show');
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => {});
            }
        }

        function closeFullscreen() {
            document.getElementById('fs-overlay').classList.remove('show');
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(err => {});
            }
        }

        // --- Modal ---
        function showModal(title, msg, callback) {
            if(isModalOpen) return;
            isModalOpen = true;
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerHTML = msg;
            const btn = document.getElementById('modal-confirm-btn');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => { closeModal(); callback(); };
            document.getElementById('custom-modal').classList.add('show');
        }
        function closeModal() {
            document.getElementById('custom-modal').classList.remove('show');
            setTimeout(() => { isModalOpen = false; }, 300);
        }
    </script>
</body>
</html>
