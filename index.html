<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / Mobile Web App è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <title>ç¾½çƒæ’ç¨‹ (Supabaseç‰ˆ)</title>
    
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/zxuan-c/badminton-partner-v4/refs/heads/main/icon.jpg">

    <!-- Supabase SDK (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root {
            --primary: #2c3e50;
            --accent: #27ae60; /* ç¶ è‰² */
            --danger: #e74c3c; /* ç´…è‰² */
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #333;
            --modal-bg: rgba(0, 0, 0, 0.6);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            color: var(--text);
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        button {
            cursor: pointer;
            border: none;
            outline: none;
            font-family: inherit;
            font-weight: bold;
            transition: transform 0.1s, opacity 0.1s;
            user-select: none;
        }
        button:active { transform: scale(0.96); opacity: 0.9; }

        /* --- å…¨è¢å¹•è¨ˆåˆ†æ¨¡å¼ (ä¿®å¾©ç‰ˆ) --- */
        #fs-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; 
            height: 100svh; /* ç¢ºä¿ä¸è¢«ç€è¦½å™¨å·¥å…·åˆ—é®æ“‹ */
            background: #000;
            z-index: 2000;
            flex-direction: column;
            color: white;
            padding-top: max(env(safe-area-inset-top), 10px);
            padding-bottom: max(env(safe-area-inset-bottom), 10px);
        }
        #fs-overlay.show { display: flex; }

        .fs-close-btn {
            position: absolute;
            top: max(env(safe-area-inset-top), 15px); 
            right: 20px;
            width: 40px; height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.8);
            font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            z-index: 2001;
            cursor: pointer;
        }

        .fs-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .fs-team {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .fs-names {
            font-size: clamp(1.2rem, 5vmin, 2.5rem); 
            color: #ccc;
            text-align: center;
            margin-bottom: 2vh;
            font-weight: bold;
            line-height: 1.2;
            padding: 0 5px;
            word-break: break-word;
        }

        .fs-score {
            font-size: 35vmin; 
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
            margin-bottom: 2vh;
            font-variant-numeric: tabular-nums;
            cursor: pointer;
            text-shadow: 0 0 10px rgba(39, 174, 96, 0.3);
        }

        .fs-controls {
            display: flex;
            gap: 20px;
        }

        .fs-btn {
            width: 10vmin; height: 10vmin;
            min-width: 50px; min-height: 50px;
            max-width: 80px; max-height: 80px;
            border-radius: 50%;
            font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            color: white;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        .fs-btn.minus { background: var(--danger); opacity: 0.8; }
        .fs-btn.plus { background: var(--accent); }

        .fs-divider {
            width: 1px;
            height: 50%;
            background: #333;
            margin: 0 10px;
        }

        /* --- è‡ªè¨‚å½ˆè·³è¦–çª— (Modal) --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
        
        .modal-card {
            background: white;
            width: 85%;
            max-width: 320px;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-title { font-size: 1.4rem; font-weight: 900; color: var(--primary); margin-bottom: 10px; }
        .modal-msg { font-size: 1rem; color: #555; margin-bottom: 20px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 1rem; }
        .btn-cancel { background: #eee; color: #666; }
        .btn-confirm { background: var(--accent); color: white; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- é é¢å®¹å™¨ --- */
        .page {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 100%;
        }

        #room-page {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #setup-page { display: none; overflow-y: auto; }
        
        .setup-card {
            background: var(--card);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
            margin-top: 20px;
        }

        input {
            width: 100%; padding: 12px; font-size: 1rem;
            border: 2px solid #ddd; border-radius: 8px;
            margin-bottom: 10px;
            -webkit-appearance: none;
        }
        
        .player-tag {
            display: inline-flex;
            align-items: center;
            background: #e9ecef;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 1rem;
        }
        .player-tag span { color: #999; margin-left: 8px; cursor: pointer; font-size: 1.2rem; }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .mode-label {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .mode-label.selected {
            background: #e8f5e9;
            border-color: var(--accent);
            color: var(--accent);
            font-weight: bold;
        }

        #app-page {
            display: none;
            flex-direction: column;
            padding: 0;
            max-width: 100%;
            height: 100%;
            background: #222;
        }

        .scoreboard-section {
            flex: 1;
            background: var(--card);
            border-radius: 0 0 30px 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            padding: 15px;
            position: relative;
            z-index: 10;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            overflow-y: auto;
        }

        .match-info-bar {
            text-align: center;
            color: #888;
            font-size: 1rem;
            border-bottom: 1px solid #f5f5f5;
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .target-score-badge {
            background: #eee;
            color: #666;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .room-badge {
            background: #e3f2fd;
            color: #1565c0;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .scores-display {
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex: 1;
            margin-bottom: 10px;
        }

        .team-block {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .team-names {
            font-size: 1.5rem; 
            font-weight: 900;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            line-height: 1.2;
            min-height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-direction: column;
            word-break: break-word;
            padding: 0 5px;
        }

        .score-number {
            font-size: clamp(4rem, 15vh, 8rem);
            line-height: 1;
            font-weight: 800;
            color: var(--primary);
            margin: 5px 0 15px 0;
            font-variant-numeric: tabular-nums;
            cursor: pointer;
        }

        .score-controls {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .btn-control {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            color: white;
        }
        .btn-minus { background-color: var(--danger); }
        .btn-plus { background-color: var(--accent); }

        .vs-text {
            font-size: 1.5rem;
            color: #e0e0e0;
            font-weight: 900;
            margin: 0 10px;
            font-style: italic;
            align-self: center;
        }

        .next-match-area {
            margin-top: auto;
            padding-top: 15px;
            display: flex; /* æ”¹ç‚º Flex ä½ˆå±€ */
            gap: 10px;
        }
        .btn-finish {
            flex: 2; /* ä½”æ“šè¼ƒå¤šç©ºé–“ */
            background: var(--primary);
            color: white;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.4);
        }
        .btn-prev {
            flex: 1; /* ä½”æ“šè¼ƒå°‘ç©ºé–“ */
            background: #ffffff;
            color: #7f8c8d;
            border: 2px solid #bdc3c7;
            padding: 15px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .btn-prev:active { background: #f0f0f0; }

        .schedule-section {
            height: 30vh;
            min-height: 180px;
            flex: none;
            background: #f0f2f5;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 5px;
            color: #666;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .schedule-list { flex: 1; }

        .match-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            font-size: 1rem;
            border-left: 5px solid transparent;
        }
        .match-card.active { border-left-color: var(--accent); background: #fff; }
        .match-card.finished { opacity: 0.6; background: #e9ecef; color: #888; }

        .score-badge {
            background: #eee;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #555;
            min-width: 60px;
            text-align: center;
            font-size: 0.9rem;
        }
        .active .score-badge { background: var(--accent); color: white; }
        .btn-green { background: var(--accent); color: white; border-radius: 8px; padding: 10px 20px; }
        .btn-outline { border: 1px solid #aaa; background: white; color: #555; border-radius: 6px; padding: 5px 12px; font-size: 0.85rem; }

        .loading { color: #999; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <!-- å…¨è¢å¹•è¨ˆåˆ†æ¨¡å¼ -->
    <div id="fs-overlay">
        <button class="fs-close-btn" onclick="closeFullscreen()">âœ•</button>
        <div class="fs-container">
            <div class="fs-team">
                <div class="fs-names" id="fs-t1-names"></div>
                <div class="fs-score" id="fs-t1-score" onclick="updateScore(1, 1)">0</div>
                <div class="fs-controls">
                    <button class="fs-btn minus" onclick="updateScore(1, -1)">-</button>
                    <button class="fs-btn plus" onclick="updateScore(1, 1)">+</button>
                </div>
            </div>
            
            <div class="fs-divider"></div>

            <div class="fs-team">
                <div class="fs-names" id="fs-t2-names"></div>
                <div class="fs-score" id="fs-t2-score" onclick="updateScore(2, 1)">0</div>
                <div class="fs-controls">
                    <button class="fs-btn minus" onclick="updateScore(2, -1)">-</button>
                    <button class="fs-btn plus" onclick="updateScore(2, 1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å½ˆè·³è¦–çª— -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-msg" id="modal-msg"></div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" id="modal-confirm-btn">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- 0. æˆ¿é–“é¸æ“‡é é¢ -->
    <div id="room-page" class="page">
        <div class="setup-card" style="text-align:center;">
            <h1 style="color:var(--primary); margin-bottom:10px;">ğŸ¸ é€£ç·šç¾½çƒæ’ç¨‹</h1>
            <p style="color:#666; margin-bottom:20px;">è«‹è¼¸å…¥çƒéšŠä»£ç¢¼ (Room ID)<br>è®“å¤§å®¶é€²å…¥åŒä¸€å€‹æˆ¿é–“</p>
            
            <input type="text" id="room-id-input" placeholder="ä¾‹å¦‚: team_friday" style="text-align:center; font-size:1.2rem; font-weight:bold;">
            <button class="btn-green" style="width:100%; padding:15px; font-size:1.1rem;" onclick="joinRoom()">é€²å…¥æˆ¿é–“</button>
            <div id="loading-text" class="loading" style="display:none;">æ­£åœ¨é€£ç·š Supabase...</div>
        </div>
    </div>

    <!-- 1. è¨­å®šé é¢ -->
    <div id="setup-page" class="page">
        <div class="setup-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color: var(--primary); margin:0;">è¨­å®šèˆ‡åå–®</h2>
                <span id="room-display-setup" class="room-badge"></span>
            </div>
            
            <div style="text-align:center; margin-bottom:5px; color:#666; font-size:0.9rem;">é¸æ“‡è³½åˆ¶</div>
            <div class="mode-selector">
                <label class="mode-label selected" onclick="selectMode(21, this)">
                    21åˆ†åˆ¶
                    <input type="radio" name="mode" value="21" checked>
                </label>
                <label class="mode-label" onclick="selectMode(11, this)">
                    11åˆ†åˆ¶
                    <input type="radio" name="mode" value="11">
                </label>
            </div>

            <p style="color:#666; font-size:0.9rem; margin-top:10px;">åå–® (æ›´å‹•æœƒå³æ™‚åŒæ­¥)</p>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="input-name" placeholder="è¼¸å…¥åå­— (æŒ‰Enter)" autocomplete="off">
                <button class="btn-green" onclick="addPlayer()">æ–°å¢</button>
            </div>

            <div id="player-list" style="margin-bottom:20px; min-height: 50px;"></div>

            <button class="btn-green" style="width:100%; padding:15px; font-size:1.1rem; margin-bottom:15px;" onclick="startSystem()">
                é–‹å§‹ / ç¹¼çºŒæ¯”è³½
            </button>
            
            <div style="text-align:center;">
                <button class="btn-outline" onclick="exitRoom()">é›¢é–‹æˆ¿é–“</button>
            </div>
        </div>
    </div>

    <!-- 2. ä¸»æ‡‰ç”¨é é¢ -->
    <div id="app-page">
        <div class="scoreboard-section">
            <div class="match-info-bar">
                ç¬¬ <span id="match-id" style="font-weight:bold; color:var(--primary);">1</span> å ´
                <span id="target-score-display" class="target-score-badge">21åˆ†åˆ¶</span>
                <span id="room-display-app" class="room-badge" style="margin-left:5px;"></span>
                <button class="btn-outline" style="margin-left:auto; padding:5px 10px;" onclick="openFullscreen()">â›¶ å…¨è¢å¹•</button>
            </div>

            <div class="scores-display">
                <div class="team-block">
                    <div class="team-names" id="t1-names"></div>
                    <div class="score-number" id="t1-score" onclick="updateScore(1, 1)">0</div>
                    <div class="score-controls">
                        <button class="btn-control btn-minus" onclick="updateScore(1, -1)">-</button>
                        <button class="btn-control btn-plus" onclick="updateScore(1, 1)">+</button>
                    </div>
                </div>
                <div class="vs-text">VS</div>
                <div class="team-block">
                    <div class="team-names" id="t2-names"></div>
                    <div class="score-number" id="t2-score" onclick="updateScore(2, 1)">0</div>
                    <div class="score-controls">
                        <button class="btn-control btn-minus" onclick="updateScore(2, -1)">-</button>
                        <button class="btn-control btn-plus" onclick="updateScore(2, 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="next-match-area">
                <button class="btn-prev" onclick="goToPreviousMatch()">â¬…ï¸ ä¸Šä¸€å ´</button>
                <button class="btn-finish" id="main-action-btn" onclick="manualFinishClick()">çµæŸæœ¬å ´ (ä¸‹ä¸€å ´) â”</button>
            </div>
        </div>

        <div class="schedule-section">
            <div class="schedule-header">
                <span>è³½ç¨‹è¡¨</span>
                <div>
                    <button class="btn-outline" onclick="clearData()" style="color:var(--danger); border-color:var(--danger);">å…¨éƒ¨é‡ç½®</button>
                    <button class="btn-outline" onclick="addMoreMatches()">+ ç”¢ç”Ÿ</button>
                </div>
            </div>
            <div class="schedule-list" id="schedule-container"></div>
        </div>
    </div>

    <script>
        // --- è¨­å®š (è«‹å¡«å…¥æ‚¨çš„ Supabase è³‡è¨Š) ---
        const SUPABASE_URL = 'https://dgdolkbubvyggijsddtl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_-tIVFIoo0VXjtrWrKadCgw__QO8IAbW';

        // --- Init ---
        let supabase;
        let realtimeChannel = null;
        let currentRoomId = "";

        // --- App State ---
        const DEFAULT_STATE = {
            players: [],
            schedule: [],
            currentIdx: 0,
            partnerships: {},
            targetScore: 21
        };
        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        let tempTargetScore = 21;
        let isModalOpen = false;

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient === 'undefined') {
                console.error("Supabase SDK not loaded");
                alert("Supabase SDK è¼‰å…¥å¤±æ•—");
                return;
            }

            try {
                // @ts-ignore
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } catch (e) { console.error(e); }

            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if(roomParam) {
                document.getElementById('room-id-input').value = roomParam;
                joinRoom();
            }

            document.getElementById('input-name').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addPlayer();
            });
            document.getElementById('room-id-input').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') joinRoom();
            });
        });

        // --- æˆ¿é–“èˆ‡é€£ç·šé‚è¼¯ ---
        async function joinRoom() {
            const input = document.getElementById('room-id-input');
            const roomId = input.value.trim();
            if(!roomId) { showModal("æç¤º", "è«‹è¼¸å…¥æˆ¿é–“ä»£ç¢¼", ()=>{}); return; }

            currentRoomId = roomId;
            document.getElementById('loading-text').style.display = 'block';

            // 1. è®€å–åˆå§‹è³‡æ–™
            const { data, error } = await supabase
                .from('rooms')
                .select('data')
                .eq('id', roomId)
                .single();

            if (error && error.code !== 'PGRST116') { 
                console.error("Fetch error:", error);
            }

            if (data && data.data) {
                state = data.data;
            } else {
                await saveData(); 
            }
            
            // 2. è¨‚é–±å³æ™‚æ›´æ–°
            if(realtimeChannel) await supabase.removeChannel(realtimeChannel);
            
            realtimeChannel = supabase
                .channel('room-updates')
                .on(
                    'postgres_changes',
                    {
                        event: '*', 
                        schema: 'public',
                        table: 'rooms',
                        filter: `id=eq.${roomId}`
                    },
                    (payload) => {
                        if(payload.new && payload.new.data) {
                            state = payload.new.data;
                            syncUI();
                        }
                    }
                )
                .subscribe();

            document.getElementById('loading-text').style.display = 'none';
            syncUI();
            
            if(state.schedule.length > 0) {
                showAppPage();
            } else {
                showSetupPage();
            }

            document.getElementById('room-display-setup').innerText = roomId;
            document.getElementById('room-display-app').innerText = roomId;
            
            try {
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + roomId;
                window.history.replaceState({path:newUrl},'',newUrl);
            } catch(e){}
        }

        async function saveData() {
            if(!currentRoomId || !supabase) return;
            const { error } = await supabase
                .from('rooms')
                .upsert({ id: currentRoomId, data: state });
            if(error) console.error("Save error:", error);
        }

        function exitRoom() {
            if(realtimeChannel) supabase.removeChannel(realtimeChannel);
            realtimeChannel = null;
            state = JSON.parse(JSON.stringify(DEFAULT_STATE));
            currentRoomId = "";
            document.getElementById('app-page').style.display = 'none';
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('room-page').style.display = 'flex';
        }

        // --- åŒæ­¥ UI (ä¿®æ­£ç‰ˆ) ---
        function syncUI() {
            renderPlayers();
            updateModeUI();
            
            if(state.schedule.length > 0) {
                // å„ªå…ˆä¿¡ä»» DB ä¸­çš„ currentIdxï¼Œé™¤éå®ƒæ˜¯ç„¡æ•ˆçš„
                if (typeof state.currentIdx !== 'number' || state.currentIdx < 0 || state.currentIdx >= state.schedule.length) {
                     // åªæœ‰ç•¶ç´¢å¼•ç„¡æ•ˆæ™‚ï¼Œæ‰è‡ªå‹•è·³è½‰åˆ°ç¬¬ä¸€å€‹æœªå®Œæˆçš„æ¯”è³½
                     let activeIdx = state.schedule.findIndex(m => m.status !== 'finished');
                     if(activeIdx === -1) activeIdx = state.schedule.length - 1;
                     state.currentIdx = activeIdx;
                }

                updateScoreUI();
                renderSchedule();
                
                // ç¢ºä¿åœ¨ App é é¢
                const isAppVisible = document.getElementById('app-page').style.display === 'flex';
                if(!isAppVisible && state.schedule.length > 0) {
                    showAppPage();
                }
            }
        }

        // --- é é¢åˆ‡æ› ---
        function showSetupPage() {
            document.getElementById('room-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'none';
            document.getElementById('setup-page').style.display = 'flex';
        }

        function showAppPage() {
            document.getElementById('room-page').style.display = 'none';
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('app-page').style.display = 'flex';
            
            // æ‰¾å‡ºæ­£åœ¨é€²è¡Œçš„å ´æ¬¡ (åˆå§‹è¼‰å…¥æ™‚)
            let idx = state.schedule.findIndex(m => m.status !== 'finished');
            if(idx === -1 && state.schedule.length > 0) idx = state.schedule.length - 1;
            else if(idx === -1) { showSetupPage(); return; }
            
            // åªæœ‰åˆå§‹é€²å…¥æ™‚æ‰è¦†è“‹ currentIdx
            // å¦‚æœå·²ç¶“æœ‰ currentIdx (ä¾†è‡ªåŒæ­¥)ï¼ŒsyncUI æœƒè™•ç†
            // é€™è£¡ä¸»è¦æ˜¯ç‚ºäº†ç¬¬ä¸€æ¬¡è¼‰å…¥æ²’è³‡æ–™æ™‚çš„é˜²å‘†
            if (typeof state.currentIdx !== 'number') {
                state.currentIdx = idx;
            }
            
            // è§¸ç™¼ç‹€æ…‹æ›´æ–°
            if(state.schedule[state.currentIdx] && state.schedule[state.currentIdx].status === 'pending') {
                state.schedule[state.currentIdx].status = 'active';
                saveData();
            }
            updateScoreUI();
            renderSchedule();
        }

        // --- æ¥­å‹™é‚è¼¯ ---
        function selectMode(score, element) {
            tempTargetScore = score;
            document.querySelectorAll('.mode-label').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        function updateModeUI() {
            const currentScore = state.targetScore || 21;
            const radios = document.getElementsByName('mode');
            radios.forEach(r => {
                if(parseInt(r.value) === currentScore) {
                    r.checked = true;
                    r.parentElement.classList.add('selected');
                } else {
                    r.parentElement.classList.remove('selected');
                }
            });
        }

        function addPlayer() {
            const input = document.getElementById('input-name');
            const name = input.value.trim();
            if(!name) return;
            if(state.players.find(p => p.name === name)) { 
                showModal("æç¤º", "åå­—é‡è¤‡å›‰", ()=>{}); 
                return; 
            }
            state.players.push({ name, played: 0 });
            input.value = '';
            saveData();
        }

        function renderPlayers() {
            const div = document.getElementById('player-list');
            if(state.players.length === 0) {
                div.innerHTML = '<p style="color:#999; padding:10px;">åå–®ç©ºç™½</p>';
                return;
            }
            div.innerHTML = state.players.map((p, i) => `
                <div class="player-tag">${p.name} <span onclick="removePlayer(${i})">Ã—</span></div>
            `).join('');
        }

        function removePlayer(idx) {
            state.players.splice(idx, 1);
            saveData();
        }

        function startSystem() {
            if(state.players.length < 4) { showModal("æç¤º","è‡³å°‘éœ€è¦4äºº",()=>{}); return; }
            state.targetScore = tempTargetScore;
            
            if(state.schedule.length === 0) {
                state.partnerships = {};
                generateMatches(10);
            } else {
                saveData();
                showAppPage();
            }
        }

        function generateMatches(count) {
            const startId = state.schedule.length + 1;
            for(let i=0; i<count; i++) {
                let pool = [...state.players];
                pool.sort((a, b) => (a.played - b.played) || (Math.random() - 0.5));
                const picked = pool.slice(0, 4);
                
                picked.forEach(p => {
                    const realP = state.players.find(x => x.name === p.name);
                    if(realP) realP.played++;
                });

                const t1 = [picked[0], picked[1]];
                const t2 = [picked[2], picked[3]];

                state.schedule.push({
                    id: startId + i,
                    t1: t1.map(p=>p.name),
                    t2: t2.map(p=>p.name),
                    s1: 0, s2: 0, status: 'pending'
                });
            }
            saveData();
        }

        function updateScoreUI() {
            if(!state.schedule[state.currentIdx]) return;
            const m = state.schedule[state.currentIdx];
            const target = state.targetScore || 21;

            document.getElementById('match-id').innerText = m.id;
            document.getElementById('target-score-display').innerText = `${target}åˆ†åˆ¶`;
            
            // ä¸€èˆ¬ä»‹é¢
            document.getElementById('t1-names').innerText = `${m.t1[0]} / ${m.t1[1]}`;
            document.getElementById('t2-names').innerText = `${m.t2[0]} / ${m.t2[1]}`;
            document.getElementById('t1-score').innerText = m.s1;
            document.getElementById('t2-score').innerText = m.s2;

            // å…¨è¢å¹•ä»‹é¢åŒæ­¥æ›´æ–°
            document.getElementById('fs-t1-names').innerText = `${m.t1[0]} / ${m.t1[1]}`;
            document.getElementById('fs-t2-names').innerText = `${m.t2[0]} / ${m.t2[1]}`;
            document.getElementById('fs-t1-score').innerText = m.s1;
            document.getElementById('fs-t2-score').innerText = m.s2;

            // æŒ‰éˆ•ç‹€æ…‹åˆ‡æ›
            const btn = document.getElementById('main-action-btn');
            if (m.status === 'finished') {
                btn.innerText = "â†©ï¸ æ¢å¾©æ¯”è³½ (ä¿®æ”¹æ¯”åˆ†)";
                btn.onclick = resumeMatch;
                btn.style.background = '#95a5a6'; // ç°è‰²è¡¨ç¤ºå·²çµæŸ
            } else {
                btn.innerText = "çµæŸæœ¬å ´ (ä¸‹ä¸€å ´) â”";
                btn.onclick = manualFinishClick;
                btn.style.background = 'var(--primary)';
            }
        }

        function updateScore(team, delta) {
            if(isModalOpen) return;
            const m = state.schedule[state.currentIdx];
            if(!m || m.status === 'finished') return;

            if(team === 1) m.s1 = Math.max(0, m.s1 + delta);
            else m.s2 = Math.max(0, m.s2 + delta);

            const target = state.targetScore || 21;
            const maxS = Math.max(m.s1, m.s2);
            const diff = Math.abs(m.s1 - m.s2);

            if(maxS >= target && diff >= 2) {
                finishMatch(state.currentIdx);
            } else {
                saveData();
            }
        }

        function manualFinishClick() {
            const m = state.schedule[state.currentIdx];
            if(!m || m.status === 'finished') return;
            finishMatch(state.currentIdx);
        }

        function finishMatch(idx) {
            if(state.schedule[idx]) {
                state.schedule[idx].status = 'finished';
                
                // æœ¬åœ°é å…ˆè¨ˆç®—ä¸‹ä¸€å ´ï¼Œç¢ºä¿UIå³æ™‚åæ‡‰
                let nextIdx = state.schedule.findIndex(m => m.status !== 'finished' && m !== state.schedule[idx]);
                // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå¯èƒ½å°±æ˜¯å‰›çµæŸçš„ä¸‹ä¸€å ´
                if(nextIdx === -1 && idx < state.schedule.length - 1) {
                    nextIdx = idx + 1;
                }
                
                if (nextIdx !== -1) {
                    state.currentIdx = nextIdx;
                    if(state.schedule[nextIdx].status === 'pending') {
                        state.schedule[nextIdx].status = 'active';
                    }
                }
                
                saveData();
                syncUI(); // ç«‹å³æ›´æ–° UI
            }
        }

        // --- æ–°å¢åŠŸèƒ½ï¼šå›åˆ°ä¸Šä¸€å ´ ---
        function goToPreviousMatch() {
            if (state.currentIdx > 0) {
                state.currentIdx--;
                saveData();
                syncUI();
            } else {
                showModal("æç¤º", "é€™å·²ç¶“æ˜¯ç¬¬ä¸€å ´æ¯”è³½äº†", ()=>{});
            }
        }

        // --- æ–°å¢åŠŸèƒ½ï¼šæ¢å¾©æ¯”è³½ ---
        function resumeMatch() {
            const m = state.schedule[state.currentIdx];
            if (m) {
                m.status = 'active';
                saveData();
                syncUI();
            }
        }

        function addMoreMatches() {
            generateMatches(5);
        }

        function clearData() {
            showModal("è­¦å‘Š", "é€™æœƒæ¸…é™¤æ­¤æˆ¿é–“æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ", () => {
                state = JSON.parse(JSON.stringify(DEFAULT_STATE));
                state.targetScore = tempTargetScore;
                saveData();
                showSetupPage();
            });
        }

        function renderSchedule() {
            const div = document.getElementById('schedule-container');
            div.innerHTML = state.schedule.map((m, i) => {
                const isCur = i === state.currentIdx;
                const activeClass = isCur ? 'active' : '';
                const finishedClass = m.status === 'finished' ? 'finished' : '';
                const scoreText = m.status === 'pending' ? 'vs' : `${m.s1}:${m.s2}`;
                
                return `
                    <div class="match-card ${activeClass} ${finishedClass}" id="match-${i}">
                        <div style="width:30px; color:#999; font-size:0.9rem;">${m.id}</div>
                        <div style="flex:1; text-align:right; font-weight:500;">${m.t1[0]} / ${m.t1[1]}</div>
                        <div style="margin:0 12px;" class="score-badge">${scoreText}</div>
                        <div style="flex:1; text-align:left; font-weight:500;">${m.t2[0]} / ${m.t2[1]}</div>
                    </div>
                `;
            }).join('');
            
            setTimeout(() => {
                const el = document.querySelector('.match-card.active');
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // --- å…¨è¢å¹•åŠŸèƒ½ ---
        function openFullscreen() {
            document.getElementById('fs-overlay').classList.add('show');
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => {});
            }
        }

        function closeFullscreen() {
            document.getElementById('fs-overlay').classList.remove('show');
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(err => {});
            }
        }

        // --- Modal ---
        function showModal(title, msg, callback) {
            if(isModalOpen) return;
            isModalOpen = true;
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerHTML = msg;
            const btn = document.getElementById('modal-confirm-btn');
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => { closeModal(); callback(); };
            document.getElementById('custom-modal').classList.add('show');
        }
        function closeModal() {
            document.getElementById('custom-modal').classList.remove('show');
            setTimeout(() => { isModalOpen = false; }, 300);
        }
    </script>
</body>
</html>
